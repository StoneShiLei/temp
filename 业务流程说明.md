# 采销库存系统 - 业务流程说明文档

## 目录

- [1. 系统概述](#1-系统概述)
- [2. 核心实体说明](#2-核心实体说明)
- [3. 业务类型说明](#3-业务类型说明)
- [4. 完整业务流程](#4-完整业务流程)
- [5. 状态流转规则](#5-状态流转规则)
- [6. 关键业务规则](#6-关键业务规则)
- [7. 异常处理流程](#7-异常处理流程)
- [8. 常见问题FAQ](#8-常见问题faq)

---

## 1. 系统概述

### 1.1 系统定位

采销库存系统是一个面向设备租赁和销售业务的综合管理平台，主要功能包括：

- **销售管理**：销售单创建、商品分配、订单执行、租期管理
- **采购管理**：采购单创建、状态流转、资产入库
- **库存管理**：资产信息、状态管理、地址追踪、版本升级

### 1.2 核心特性

1. **快照机制**：订单创建时自动保存客户和地址信息快照，避免修改影响历史订单
2. **智能分配**：支持闲置资产分配、预采购单匹配、自动创建采购单
3. **状态自动流转**：采购完成自动更新销售单状态，租期到期自动完成订单
4. **租金自动计算**：根据租期、赠送天数、增配价格自动计算实际租金
5. **定时任务**：自动检查收款逾期、租期到期提醒、租期到期处理
6. **钉钉通知**：关键操作自动发送钉钉通知

### 1.3 技术架构

- **后端框架**：ASP.NET Core + SqlSugar ORM
- **数据库**：SQL Server（使用雪花ID生成器）
- **前端框架**：Vue 3
- **消息通知**：钉钉机器人

---

## 2. 核心实体说明

### 2.1 销售单 (SalesOrder)

销售单是系统的核心实体，记录客户的购买或租赁需求。

**主要字段**：
- `SalesOrderId`: 销售单ID（雪花ID）
- `SalesOrderCode`: 销售单编号（格式：`TR-{业务类型}-{工号/用户ID}-{日期}-{流水号}`）
- `SalesStatus`: 销售单状态（待分配、采购中、待执行、执行中、已完成、已取消）
- `BusinessType`: 业务类型（租赁、以租代售、销售）
- `CustomerId`: 客户ID（指向客户快照）
- `DeliveryAddressId`: 收货地址ID（指向地址快照）
- `TotalDeposit`: 总押金（租赁/以租代售业务）
- `DeptId`: 部门ID
- `CreateBy`, `CreateTime`: 创建人、创建时间
- `UpdateBy`, `UpdateTime`: 更新人、更新时间

**关联实体**：
- `ProductDemands`: 商品需求列表（一对多）
- `PaymentRecords`: 收款单列表（一对多）
- `LeasePeriods`: 租期管理列表（一对多，通过关联表）

**代码参考**：
- 实体定义：`ZR.Model/Sales/SalesOrder.cs`
- 服务实现：`ZR.Service/Sales/SalesOrderService.cs:210-363`（创建）、`370-617`（更新）

---

### 2.2 商品需求 (SalesOrderProductDemand)

记录销售单中每个商品的需求信息，包括数量、价格、租期等。

**主要字段**：
- `DemandId`: 需求ID
- `SalesOrderId`: 所属销售单ID
- `SalesOrderCode`: 销售单编号（冗余字段，便于查询）
- `ProductInstanceId`: 商品实例ID（关联商品规格）
- `RequiredQuantity`: 需求数量
- `UnitPrice`: 单价（月租金或售价）
- `CommissionPrice`: 资源费（仅租赁业务）
- `RentalPeriod`: 租期月数（仅租赁业务）
- `Remark`: 备注

**关联实体**：
- `ProductInstanceNav`: 商品实例（一对一）
- `AssetRelations`: 资产关联（一对多，通过关联表）
- `PurchaseOrderRelations`: 采购单关联（一对多，通过关联表）

---

### 2.3 采购单 (PurchaseOrder)

采购单记录向供应商采购设备的信息，采购完成后自动生成资产入库。

**主要字段**：
- `PurchaseOrderId`: 采购单ID
- `PurchaseOrderCode`: 采购单编号（格式：`PO{yyyyMMdd}{0000}`）
- `PurchaseStatus`: 采购状态（待下单、已下单、已完成）
- `PurchaseSource`: 采购来源（手动创建、销售单创建）
- `IsPrePurchase`: 是否预采购单
- `ProductInstanceId`: 商品实例ID
- `AssetCode`: 资产编码（入库时分配）
- `AssetId`: 资产ID（完成后回填）
- `DeliveryAddressId`: 收货地址ID
- `Remark`: 备注

**业务规则**：
- 手动创建的采购单默认状态为"已下单"
- 销售单创建的采购单默认状态为"待下单"，不能是预采购单
- 预采购单不允许填写收货地址（匹配销售单后自动填入）
- 采购单只能顺序流转：待下单 → 已下单 → 已完成
- 已完成的采购单不能修改和删除

**代码参考**：
- 服务实现：`ZR.Service/Purchase/PurchaseOrderService.cs:194-270`（创建）、`835-1085`（状态流转）

---

### 2.4 资产 (Asset)

资产是系统的库存实体，记录每个设备的详细信息和状态。

**主要字段**：
- `AssetId`: 资产ID
- `AssetCode`: 资产编码（唯一，手动填写或自动生成）
- `AssetStatus`: 资产状态（闲置、在租、锁定、维修、售出、报废）
- `AssetSource`: 资产来源（采购入库、手动创建）
- `ProductInstanceId`: 商品实例ID
- `ProvinceCode`, `ProvinceName`: 省份代码、名称
- `CityCode`, `CityName`: 城市代码、名称
- `LocationDetail`: 详细地址
- `ResponsibleUserId`: 责任人ID
- `Remark`: 备注

**状态流转**：
- 闲置 → 锁定：分配给销售单
- 锁定 → 在租：执行订单（租赁业务）
- 锁定 → 售出：执行订单（销售业务）
- 在租 → 闲置：退租
- 锁定 → 闲置：销售单中止

**代码参考**：
- 服务实现：`ZR.Service/AssetNS/AssetService.cs:661-745`（状态更新）

---

### 2.5 租期管理 (LeasePeriod)

记录租赁业务的租期信息，包括起租日期、结束日期、赠送天数等。

**主要字段**：
- `LeasePeriodId`: 租期ID
- `RelationId`: 关联记录ID（需求-资产关联表ID）
- `SalesOrderId`: 销售单ID
- `DemandId`: 需求ID
- `AssetId`: 资产ID
- `LeaseStartDate`: 起租日期
- `LeaseEndDate`: 结束日期
- `BonusDays`: 赠送天数
- `IsBonusAtStart`: 赠送天数是否前置
- `LeaseStatus`: 租期状态（待执行、执行中、已完成、已取消）

**租期计算规则**：
- 结束日期 = 起租日期 + 租期月数（按自然月）
- 如果赠送天数后置：结束日期 += 赠送天数
- 如果赠送天数前置：结束日期不变（实际起租日期提前）

**代码参考**：
- 服务实现：`ZR.Service/Sales/LeasePeriodService.cs:29-42`（核心计算逻辑）

---

### 2.6 收款单 (PaymentRecord)

记录所有收款信息，包括押金、销售款、租金等。

**主要字段**：
- `PaymentRecordId`: 收款单ID
- `PaymentType`: 收款类型（押金、销售、租金）
- `PaymentStatus`: 收款状态（待支付、已收款、已逾期）
- `SalesOrderId`: 销售单ID
- `RelationId`: 关联记录ID（租金单专用）
- `DemandId`: 需求ID（租金单专用）
- `AssetId`: 资产ID（租金单专用）
- `ExpectedAmount`: 应收金额
- `ActualPrice`: 实际月租金（租金单专用）
- `ExpectedPaymentDate`: 预计收款日期
- `ActualPaymentDate`: 实际收款日期
- `PeriodNumber`: 期数（租金单专用）
- `PeriodStartDate`, `PeriodEndDate`: 租期开始、结束日期（租金单专用）

**收款类型说明**：
- **押金/销售款**：商品分配完成后自动生成，必须支付才能执行订单
- **租金**：执行订单时根据租期自动生成分期收款单

**代码参考**：
- 服务实现：`ZR.Service/Sales/PaymentRecordService.cs:281-350`（租金生成）

---

### 2.7 客户 (Customer) 和收货地址 (DeliveryAddress)

**快照机制**：
- 创建销售单时，系统自动创建客户和地址的快照副本
- 快照特征：`IsSnapshot = true`，`CreateBy = null`
- 快照数据不出现在用户的客户/地址列表中
- 修改销售单时更新快照内容，不影响原始数据
- 原始数据的 `LastUsedTime` 会更新，便于排序显示

**作用**：
- 保证历史订单数据不受后续修改影响
- 方便查询和统计历史交易信息

**代码参考**：
- 销售单创建快照：`ZR.Service/Sales/SalesOrderService.cs:221-278`
- 销售单更新快照：`ZR.Service/Sales/SalesOrderService.cs:387-502`

---

## 3. 业务类型说明

系统支持三种业务类型，每种类型的处理流程有所不同：

### 3.1 租赁（BusinesType.租赁 = 1）

**特点**：
- 设备租赁给客户使用，租期结束后归还
- 需要收取押金和按期租金
- 资产状态流转：闲置 → 锁定 → 在租 → 闲置
- 支持退租和中止

**收款方式**：
1. **押金**：商品分配完成后生成，执行订单前必须支付
2. **租金**：执行订单时按租期自动生成分期收款单

**租期计算**：
- 按自然月分期
- 支持赠送天数（前置或后置）
- 实际月租金根据赠送天数自动调整

**代码参考**：
- 执行订单：`ZR.Service/Sales/SalesOrderService.cs:2006-2112`（租赁流程）

---

### 3.2 以租代售（BusinesType.以租代售 = 2）

**特点**：
- 初期按租赁模式运作，租期结束后设备归客户所有
- 需要收取押金和按期租金
- 资产状态流转：闲置 → 锁定 → 在租 → 售出
- 支持退租和中止（租期结束前）

**收款方式**：
- 同租赁模式

**与租赁的区别**：
- 租期到期后，资产不回收，状态变为"售出"
- 销售单状态变为"已完成"

**代码参考**：
- 同租赁流程，业务类型判断：`ZR.Service/Sales/SalesOrderService.cs:2115-2117`

---

### 3.3 销售（BusinesType.销售 = 3）

**特点**：
- 设备直接出售给客户
- 只需收取销售款，无租期管理
- 资产状态流转：闲置 → 锁定 → 售出
- 执行订单后直接完成，无中间状态

**收款方式**：
- **销售款**：商品分配完成后生成，执行订单前必须支付
- 销售款金额 = Σ(需求单价 × 需求数量)

**流程简化**：
- 无租期管理
- 无租金收款单
- 执行订单后直接完成

**代码参考**：
- 执行订单：`ZR.Service/Sales/SalesOrderService.cs:1978-1986`（销售流程）

---

## 4. 完整业务流程

### 4.1 销售单创建流程

**步骤**：

1. **填写销售单信息**
   - 选择客户（支持新建）
   - 选择收货地址（支持新建）
   - 选择业务类型（租赁/以租代售/销售）
   - 填写押金金额（租赁/以租代售必填）

2. **添加商品需求**
   - 选择商品模板
   - 选择商品属性（配置）
   - 填写需求数量
   - 填写单价（月租金或售价）
   - 填写资源费（租赁业务）
   - 填写租期月数（租赁业务）

3. **提交创建**
   - 系统自动生成销售单编号
   - 创建客户和地址快照
   - 创建商品实例（保存配置信息）
   - 创建商品需求记录
   - 创建初始状态流转日志
   - 销售单状态：**待分配**
   - 发送钉钉通知

**代码参考**：`ZR.Service/Sales/SalesOrderService.cs:210-363`

**注意事项**：
- 销售单编号一旦生成不可修改
- 客户和地址为快照数据，修改销售单时不会影响原始客户/地址
- 商品需求创建后会关联商品实例，记录详细配置

---

### 4.2 商品分配流程

销售单创建后处于"待分配"状态，需要为每个商品需求分配资产或创建采购单。

**分配方式**（可混合使用）：

#### 方式1：分配闲置资产

**适用场景**：仓库中有符合规格的闲置设备

**操作步骤**：
1. 系统根据商品实例的 `AttributeHash` 查询匹配的闲置资产
2. 优先显示与收货地址省市匹配的资产
3. 选择要分配的资产
4. 系统验证资产状态必须是"闲置"
5. 资产状态变更为"锁定"
6. 创建需求-资产关联记录

**代码参考**：`ZR.Service/Sales/SalesOrderService.cs:833-977`（资产匹配查询）

---

#### 方式2：关联预采购单

**适用场景**：已有符合规格的预采购单尚未匹配销售单

**操作步骤**：
1. 系统根据商品实例的 `AttributeHash` 查询匹配的预采购单
2. 筛选条件：`IsPrePurchase = true` 且未关联销售单
3. 选择要关联的预采购单
4. 系统验证预采购单未被占用
5. 更新预采购单的收货地址为销售单的收货地址
6. 创建需求-采购单关联记录
7. 发送预采购单被匹配通知

**代码参考**：`ZR.Service/Sales/SalesOrderService.cs:979-1070`（预采购单匹配查询）

---

#### 方式3：创建新采购单

**适用场景**：无匹配资产也无预采购单，需要新采购

**操作步骤**：
1. 指定要创建的采购单数量
2. 系统复制商品需求的商品实例
3. 批量创建采购单
   - 状态：**待下单**
   - 来源：销售单创建
   - 预采购标志：false
   - 收货地址：销售单的收货地址
4. 创建需求-采购单关联记录

**代码参考**：`ZR.Service/Sales/SalesOrderService.cs:1228-1291`（创建采购单）

---

**提交分配**：

1. **验证分配数量**：每个需求的总分配数量必须等于需求数量
2. **更新销售单状态**：
   - 如果有采购单（方式2或3）：状态变为 **采购中**
   - 如果全部分配资产（方式1）：状态变为 **待执行**
3. **生成收款单**：
   - 租赁/以租代售：生成押金收款单
   - 销售：生成销售收款单
   - 金额自动计算（销售款 = Σ需求单价×数量）

**代码参考**：`ZR.Service/Sales/SalesOrderService.cs:1078-1362`（提交分配）

---

### 4.3 采购流程

#### 4.3.1 采购单状态流转

采购单有三种状态，只能顺序流转：

```
待下单 → 已下单 → 已完成
```

**状态说明**：
- **待下单**：销售单创建的采购单默认状态，表示需要向供应商下单
- **已下单**：手动创建的采购单默认状态，或从待下单流转，表示已向供应商下单
- **已完成**：采购完成，设备已到货，系统自动入库

**代码参考**：`ZR.Service/Purchase/PurchaseOrderService.cs:1110-1130`（状态流转验证）

---

#### 4.3.2 采购单完成流程

采购单流转到"已完成"状态时，系统会执行以下操作：

**前置验证**：
1. 收货地址必须完整（省份、城市、详细地址）
2. 资产编码必须填写
3. 资产编码不能重复（检查资产表和采购单表）

**执行操作**：
1. **更新采购单状态**为"已完成"
2. **复制商品实例**：从订单需求实例复制为资产规格实例
3. **创建资产记录**：
   - 资产编码：使用采购单的资产编码
   - 资产状态：
     - 如果关联销售单：**锁定**
     - 如果未关联销售单：**闲置**
   - 资产来源：采购入库
   - 资产地址：采购单的收货地址
4. **回填资产ID**到采购单
5. **如果关联销售单**：
   - 创建需求-资产关联记录
   - 检查销售单的所有需求是否都已满足
   - 如果全部满足：
     - 创建租期管理数据（租赁业务）
     - 销售单状态变更为 **待执行**
     - 发送钉钉通知

**代码参考**：`ZR.Service/Purchase/PurchaseOrderService.cs:835-1085`（完整流程）

**注意事项**：
- 采购单完成后不能修改和删除
- 资产编码唯一性在完成时二次校验，防止并发冲突
- 如果销售单有多个采购单，需要全部完成才会变为"待执行"

---

### 4.4 订单执行流程

销售单处于"待执行"状态时，表示所有资产已准备好，可以执行订单（配送、安装、交付）。

**前置条件**：
1. 销售单状态必须是"待执行"
2. 押金/销售款必须已支付
3. 所有商品需求必须已分配资产

**执行操作根据业务类型不同**：

#### 4.4.1 销售业务

1. 销售单状态变更为 **已完成**
2. 查询销售单的收货地址
3. 批量更新所有关联资产：
   - 资产地址 = 收货地址
   - 资产状态 = **售出**
4. 流程结束

**代码参考**：`ZR.Service/Sales/SalesOrderService.cs:1978-1986`

---

#### 4.4.2 租赁/以租代售业务

1. 销售单状态变更为 **执行中**
2. 查询销售单的收货地址
3. 更新租期状态为 **执行中**
4. **为每个资产生成分期租金收款单**：
   - 查询商品需求的单价、资源费、租期月数
   - 查询资产的增配价格（从属性值表）
   - 计算实际月租金（详见"租金计算规则"）
   - 按租期月数生成收款单（按自然月分期）
   - 每个收款单包含：
     - 期数、期间开始日期、期间结束日期
     - 预计收款日期（期间开始 + 5天）
     - 应收金额（按实际使用天数比例计算）
     - 实际月租金（ActualPrice，用于计算）
5. 批量更新所有关联资产：
   - 资产地址 = 收货地址
   - 资产状态 = **在租**
6. 流程继续（进入租赁执行中状态）

**代码参考**：`ZR.Service/Sales/SalesOrderService.cs:2006-2137`

---

### 4.5 租期管理流程

#### 4.5.1 租期数据创建

- **触发时机**：采购单全部完成，销售单进入"待执行"状态
- **创建对象**：为每个需求-资产关联创建一条租期记录
- **默认值**：
  - 起租日期 = 当前日期
  - 赠送天数 = 0
  - 赠送天数前置 = false
  - 结束日期 = 起租日期 + 租期月数 - 1天
  - 租期状态 = **待执行**

**代码参考**：`ZR.Service/Sales/LeasePeriodService.cs:106-195`

---

#### 4.5.2 租期信息修改

在订单执行前（状态=待执行），可以修改租期信息：

**可修改字段**：
- 起租日期
- 赠送天数
- 赠送天数是否前置

**修改后重新计算**：
- 结束日期根据新参数重新计算
- 系统使用统一的计算方法确保一致性

**代码参考**：`ZR.Service/Sales/LeasePeriodService.cs:59-87`

---

#### 4.5.3 租金收取

租金收款单按期生成，每期的预计收款日期 = 期间开始日期 + 5天。

**收款操作**：
1. 查找待支付或已逾期的租金单
2. 更新收款状态为"已收款"
3. 记录实际收款日期

**逾期处理**：
- 定时任务每天检查收款单
- 如果当前日期 > 预计收款日期 且状态=待支付
- 自动更新状态为"已逾期"
- 发送逾期通知

**代码参考**：
- 收款状态更新：`ZR.Service/Sales/PaymentRecordService.cs:91-161`
- 逾期检查任务：`ZR.Tasks/TaskScheduler/Job_PaymentOverdue.cs`

---

#### 4.5.4 租期到期处理

**到期提醒**：
- 定时任务每天检查租期到期提醒（提前N天）
- 发送钉钉通知提醒租期即将到期

**到期处理**：
- 定时任务每天检查租期到期（结束日期 < 当前日期 且状态=执行中）
- 更新租期状态为"已完成"
- 如果该销售单所有租期都已完成，更新销售单状态为"已完成"

**代码参考**：
- 到期提醒：`ZR.Tasks/TaskScheduler/Job_LeaseExpirationReminder.cs`
- 到期处理：`ZR.Tasks/TaskScheduler/Job_LeaseExpiration.cs`

---

### 4.6 退租流程

在租期执行中，支持单个资产退租。

**操作步骤**：

1. **前置验证**：
   - 销售单状态必须是"执行中"
   - 资产必须未退租

2. **标记退租**：
   - 更新需求-资产关联记录
   - `IsReturned = true`
   - 记录退租时间和操作人

3. **删除未来租金单**：
   - 删除该资产的未来租金单
   - 条件：期间开始日期 > 当前日期 且 状态=待支付或已逾期

4. **更新资产状态**为"闲置"

5. **检查是否全部退租**：
   - 如果销售单还有未退租的资产：流程结束
   - 如果销售单所有资产都已退租：自动触发中止销售单流程

**代码参考**：`ZR.Service/Sales/SalesOrderService.cs:2172-2258`

**注意事项**：
- 退租操作不可逆
- 已支付的租金单不会删除或退款
- 全部退租会自动中止销售单

---

### 4.7 中止销售单流程

中止销售单会清理所有关联数据，恢复资产状态。

**适用状态**：
- 采购中、待执行、执行中状态可以中止
- 待分配、已完成、已取消状态不能中止

**操作步骤**：

1. **更新销售单状态**为"已取消"

2. **处理关联的采购单**：
   - 遍历所有关联的采购单
   - 如果已完成：跳过
   - 如果是预采购单：
     - 移除关联关系
     - 置空采购单的地址ID
     - 发送取消匹配通知
   - 如果是销售单创建的：
     - 删除采购单
     - 删除关联的商品实例

3. **恢复资产状态**：
   - 查询所有未退租的资产
   - 资产状态变更为"闲置"

4. **删除未来租金单**：
   - 删除条件：期间开始日期 > 当前日期 且 状态=待支付或已逾期

5. **更新租期状态**为"已取消"

**代码参考**：`ZR.Service/Sales/SalesOrderService.cs:2266-2433`

**注意事项**：
- 中止操作不可逆
- 已完成的采购单不会删除（资产已入库）
- 预采购单会保留，但移除与销售单的关联

---

## 5. 状态流转规则

### 5.1 销售单状态流转

销售单有6种状态，流转规则如下：

| 当前状态 | 可流转状态 | 触发条件 | 代码参考 |
|---------|----------|---------|---------|
| 待分配 | 采购中 | 商品分配（有采购单） | `SalesOrderService.cs:1295-1296` |
| 待分配 | 待执行 | 商品分配（全部资产） | `SalesOrderService.cs:1295-1296` |
| 待分配 | 已取消 | 手动中止 | `SalesOrderService.cs:2301` |
| 采购中 | 待执行 | 采购全部完成 | `PurchaseOrderService.cs:1048` |
| 采购中 | 已取消 | 手动中止 | `SalesOrderService.cs:2301` |
| 待执行 | 执行中 | 执行订单（租赁业务） | `SalesOrderService.cs:1986` |
| 待执行 | 已完成 | 执行订单（销售业务） | `SalesOrderService.cs:1979` |
| 待执行 | 已取消 | 手动中止 | `SalesOrderService.cs:2301` |
| 执行中 | 已完成 | 租期到期 | `Job_LeaseExpiration.cs` |
| 执行中 | 已取消 | 全部退租或手动中止 | `SalesOrderService.cs:2254-2301` |
| 已完成 | - | 终态 | - |
| 已取消 | - | 终态 | - |

**状态枚举定义**：
```csharp
public enum SalesStatus
{
    PendingAllocation = 0,  // 待分配
    Purchasing = 1,          // 采购中
    PendingExecution = 2,    // 待执行
    InExecution = 3,         // 执行中
    Completed = 4,           // 已完成
    Cancelled = 5            // 已取消
}
```

---

### 5.2 采购单状态流转

采购单有3种状态，只能顺序流转：

| 当前状态 | 下一状态 | 触发条件 | 代码参考 |
|---------|---------|---------|---------|
| 待下单 | 已下单 | 手动流转 | `PurchaseOrderService.cs:835-1085` |
| 已下单 | 已完成 | 手动流转（验证通过后） | `PurchaseOrderService.cs:835-1085` |

**状态枚举定义**：
```csharp
public enum PurchaseStatus
{
    Pending = 0,    // 待下单
    Ordered = 1,    // 已下单
    Completed = 2   // 已完成
}
```

**流转验证**：
```csharp
// 只能顺序流转
private bool IsValidStatusTransition(PurchaseStatus currentStatus, PurchaseStatus newStatus)
{
    switch (currentStatus)
    {
        case PurchaseStatus.Pending:
            return newStatus == PurchaseStatus.Ordered;
        case PurchaseStatus.Ordered:
            return newStatus == PurchaseStatus.Completed;
        case PurchaseStatus.Completed:
            return false; // 已完成不能再流转
    }
}
```

---

### 5.3 资产状态流转

资产有6种状态，流转规则如下：

| 当前状态 | 可流转状态 | 触发条件 | 代码参考 |
|---------|----------|---------|---------|
| 闲置 | 锁定 | 分配给销售单 | `SalesOrderService.cs:1146` |
| 闲置 | 维修 | 手动更新 | `AssetService.cs:661-745` |
| 闲置 | 报废 | 手动更新 | `AssetService.cs:661-745` |
| 锁定 | 在租 | 执行订单（租赁业务） | `SalesOrderService.cs:2135` |
| 锁定 | 售出 | 执行订单（销售业务） | `SalesOrderService.cs:2135` |
| 锁定 | 闲置 | 销售单中止 | `SalesOrderService.cs:2398` |
| 在租 | 闲置 | 退租 | `SalesOrderService.cs:2239` |
| 维修 | 闲置 | 维修完成 | `AssetService.cs:661-745` |
| 售出 | - | 终态 | - |
| 报废 | - | 终态 | - |

**状态枚举定义**：
```csharp
public enum AssetStatus
{
    Idle = 0,        // 闲置
    Rented = 1,      // 在租
    Locked = 2,      // 锁定
    Maintenance = 3, // 维修
    Sold = 4,        // 售出
    Scrapped = 5     // 报废
}
```

---

### 5.4 租期状态流转

租期有4种状态，流转规则如下：

| 当前状态 | 可流转状态 | 触发条件 | 代码参考 |
|---------|----------|---------|---------|
| 待执行 | 执行中 | 执行订单 | `SalesOrderService.cs:2017-2027` |
| 待执行 | 已取消 | 销售单中止 | `SalesOrderService.cs:2414-2422` |
| 执行中 | 已完成 | 租期到期 | `Job_LeaseExpiration.cs` |
| 执行中 | 已取消 | 退租或销售单中止 | `SalesOrderService.cs:2414-2422` |
| 已完成 | - | 终态 | - |
| 已取消 | - | 终态 | - |

**状态枚举定义**：
```csharp
public enum LeaseStatus
{
    PendingExecution = 0, // 待执行
    InExecution = 1,      // 执行中
    Completed = 2,        // 已完成
    Cancelled = 3         // 已取消
}
```

---

### 5.5 收款单状态流转

收款单有3种状态，流转规则如下：

| 当前状态 | 可流转状态 | 触发条件 | 代码参考 |
|---------|----------|---------|---------|
| 待支付 | 已收款 | 手动收款 | `PaymentRecordService.cs:91-161` |
| 待支付 | 已逾期 | 定时任务检查 | `Job_PaymentOverdue.cs` |
| 已逾期 | 已收款 | 手动收款 | `PaymentRecordService.cs:91-161` |
| 已收款 | - | 终态 | - |

**状态枚举定义**：
```csharp
public enum PaymentStatus
{
    Pending = 0, // 待支付
    Paid = 1,    // 已收款
    Overdue = 2  // 已逾期
}
```

---

## 6. 关键业务规则

### 6.1 数据修改规则

#### 6.1.1 销售单修改规则

| 销售单状态 | 可修改字段 | 不可修改字段 | 代码参考 |
|-----------|----------|-------------|---------|
| 待分配 | 客户、地址、押金、商品需求 | 销售单编号 | `SalesOrderService.cs:370-617` |
| 采购中 | 客户、地址、押金、商品需求 | 销售单编号 | `SalesOrderService.cs:370-617` |
| 待执行 | 客户、地址、押金 | 销售单编号、商品需求 | - |
| 执行中 | 无 | 全部 | - |
| 已完成 | 无 | 全部 | - |
| 已取消 | 无 | 全部 | - |

**特殊规则**：
- 修改销售单时自动更新快照内容
- 如果销售单状态=采购中，且收货地址发生变更：
  - 查询所有关联的采购单
  - 发送钉钉通知提醒采购人员地址已变更

**代码参考**：`SalesOrderService.cs:568-611`（地址变更通知）

---

#### 6.1.2 商品需求价格修改

商品需求的单价和资源费可以在订单执行前修改：

**适用状态**：
- 销售单状态 < 执行中（即：待分配、采购中、待执行）

**修改内容**：
- 单价（UnitPrice）
- 资源费（CommissionPrice）

**影响**：
- 修改后会影响后续的租金计算
- 押金/销售收款单金额不会自动更新（需手动调整）

**代码参考**：`SalesOrderService.cs:1876-1909`

---

#### 6.1.3 租期信息修改

租期信息可以在订单执行前修改：

**适用状态**：
- 销售单状态 = 待执行
- 租期状态 = 待执行

**可修改字段**：
- 起租日期（LeaseStartDate）
- 赠送天数（BonusDays）
- 赠送天数是否前置（IsBonusAtStart）

**自动计算**：
- 结束日期根据修改后的参数自动重新计算

**代码参考**：`LeasePeriodService.cs:59-87`

---

#### 6.1.4 收款单金额修改

收款单金额可以在支付前修改：

**适用状态**：
- 收款状态 = 待支付 或 已逾期

**修改逻辑**：
- **押金/销售收款单**：直接修改应收金额（ExpectedAmount）
- **租金收款单**：
  - 修改应收金额（ExpectedAmount）
  - 重新计算实际月租金（ActualPrice）
  - 计算公式保持不变，但用新的应收金额作为单价

**代码参考**：`PaymentRecordService.cs:169-269`

---

#### 6.1.5 采购单修改规则

| 采购单状态 | 可修改字段 | 不可修改字段 | 代码参考 |
|-----------|----------|-------------|---------|
| 待下单 | 商品规格、地址、资产编码 | 采购单编号、商品模板 | `PurchaseOrderService.cs:417-592` |
| 已下单 | 商品规格、地址、资产编码 | 采购单编号、商品模板 | `PurchaseOrderService.cs:417-592` |
| 已完成 | 无 | 全部 | - |

**特殊规则**：
- 预采购单不允许填写收货地址（匹配销售单后自动填入）
- 如果预采购单已关联销售单，不允许修改预采购标志
- 销售单创建的采购单不允许修改预采购标志
- 商品模板一旦选定不可修改（只能修改属性值）
- 资产编码修改时会检查唯一性

---

#### 6.1.6 资产修改规则

| 资产状态 | 可修改字段 | 不可修改字段 | 代码参考 |
|---------|----------|-------------|---------|
| 闲置 | 所有字段 | 资产编码（重复检查） | `AssetService.cs:472-508` |
| 锁定 | 基本信息、责任人 | 状态（由系统自动流转） | `AssetService.cs:472-508` |
| 在租 | 责任人、备注 | 状态、地址 | `AssetService.cs:472-508` |
| 维修 | 基本信息、责任人 | 状态 | `AssetService.cs:472-508` |
| 售出 | 无 | 全部 | - |
| 报废 | 无 | 全部 | - |

**特殊规则**：
- 资产编码全局唯一，修改时会检查重复
- 资产地址由订单执行时自动更新，手动修改会被覆盖
- 资产状态由业务流程自动流转，手动修改仅适用于特殊情况（如维修）

---

### 6.2 数据删除规则

#### 6.2.1 销售单删除规则

**允许删除**：
- 销售单状态 = 待分配

**删除操作**：
1. 删除商品需求-资产关联
2. 删除商品需求-采购单关联
3. 删除商品实例（包括属性值）
4. 删除商品需求记录
5. 删除收款单
6. 删除租期管理
7. 删除状态流转日志
8. 删除客户快照（如果是快照）
9. 删除地址快照（如果是快照）
10. 删除销售单主记录

**代码参考**：`SalesOrderService.cs:624-731`

**注意事项**：
- 只能删除待分配状态的订单
- 删除操作会清理所有关联数据
- 快照数据会一并删除

---

#### 6.2.2 采购单删除规则

**允许删除**：
- 采购单来源 = 手动创建
- 采购单状态 ≠ 已完成
- 未关联销售单

**不允许删除**：
- 销售单创建的采购单（由销售单中止时自动删除）
- 已完成的采购单（资产已入库）
- 已关联销售单的预采购单

**删除操作**：
- 逻辑删除（IsDeleted = true）
- 不删除商品实例（可能被其他记录引用）

**代码参考**：`PurchaseOrderService.cs:683-743`

---

#### 6.2.3 资产删除规则

**允许删除**：
- 资产状态 = 闲置
- 未关联任何订单

**删除操作**：
- 逻辑删除（IsDeleted = true）
- 不删除商品实例

**代码参考**：`AssetService.cs:509-553`

**注意事项**：
- 非闲置状态的资产不能删除
- 删除前会检查是否有订单关联

---

### 6.3 快照机制规则

#### 6.3.1 快照创建时机

- **销售单创建时**：创建客户和地址快照
- **销售单修改时**：
  - 如果已有快照：更新快照内容
  - 如果没有快照（历史数据）：创建新快照
- **采购单创建时**（仅手动创建的普通采购单）：创建地址快照

**代码参考**：
- 销售单创建快照：`SalesOrderService.cs:221-278`
- 销售单更新快照：`SalesOrderService.cs:387-502`
- 采购单创建快照：`PurchaseOrderService.cs:363-373`

---

#### 6.3.2 快照特征

- `IsSnapshot = true`：标记为快照数据
- `CreateBy = null`：快照数据的创建人为空
- 不出现在用户的客户/地址列表中
- 只能通过订单查询和访问

---

#### 6.3.3 快照与原始数据的关系

**原始数据更新**：
- 修改原始客户/地址不会影响已有订单的快照
- 快照保持订单创建时的数据内容

**最后使用时间**：
- 创建或修改销售单时，会更新原始客户/地址的 `LastUsedTime`
- 用于在列表中按最近使用时间排序

**代码参考**：
- 更新最后使用时间：`SalesOrderService.cs:321-322`、`556-563`

---

### 6.4 编号生成规则

#### 6.4.1 销售单编号

**格式**：`TR-{业务类型}-{工号/用户ID}-{yyyyMMdd}-{流水号}`

**示例**：
- `TR-ZL-123456-20250126-01`（租赁，工号123456）
- `TR-YZDS-1001-20250126-01`（以租代售，用户ID 1001）
- `TR-XS-123456-20250126-02`（销售，工号123456）

**生成逻辑**：
1. 获取业务类型映射：
   - 租赁 → ZL
   - 以租代售 → YZDS
   - 销售 → XS
2. 查询用户的钉钉工号，如果没有则使用用户ID
3. 获取当前日期（yyyyMMdd）
4. 查询当天该用户该业务类型的最大流水号
5. 流水号+1（两位补零，01-99）
6. 如果流水号超过99，抛出异常

**并发安全**：
- 使用互斥锁 `SalesOrderCodeLock` 保证同一进程内的并发安全

**代码参考**：`SalesOrderService.cs:772-831`

---

#### 6.4.2 采购单编号

**格式**：`PO{yyyyMMdd}{流水号}`

**示例**：
- `PO202501190001`
- `PO202501190002`

**生成逻辑**：
1. 获取当前日期（yyyyMMdd）
2. 查询当天的最大流水号（包含已删除的采购单）
3. 流水号+1（四位补零，0001-9999）
4. 如果流水号超过9999，抛出异常

**并发安全**：
- 使用互斥锁 `PurchaseOrderCodeLock` 保证同一进程内的并发安全

**代码参考**：`PurchaseOrderService.cs:795-825`

---

#### 6.4.3 资产编码

**格式**：自由格式，由用户或系统生成

**生成逻辑**：
- 用户可以手动填写资产编码
- 系统提供自动生成功能（可选）
- 资产编码全局唯一，创建和修改时都会检查重复

**唯一性检查**：
1. 检查资产表（排除已删除）
2. 检查采购单表（排除已删除）

**代码参考**：
- 唯一性检查：`PurchaseOrderService.cs:314-336`（创建）、`463-496`（修改）
- 采购完成时二次校验：`PurchaseOrderService.cs:891-912`

---

### 6.5 租金计算规则

#### 6.5.1 实际月租金计算

租金计算是系统的核心算法，考虑了赠送天数、增配价格和资源费。

**公式**：

```
预估收租天数 = 租期月数 ÷ 12 × 365
实际使用天数 = 预估收租天数 + 赠送天数
调整后单价 = 月租金 - 增配总价 - 资源费
实际月租金 = 调整后单价 × 预估收租天数 ÷ 实际使用天数
```

**示例**：

假设：
- 租期：12个月
- 月租金：3000元
- 资源费：100元
- 增配总价：200元（如内存升级）
- 赠送天数：30天

计算：
```
预估收租天数 = 12 ÷ 12 × 365 = 365天
实际使用天数 = 365 + 30 = 395天
调整后单价 = 3000 - 200 - 100 = 2700元
实际月租金 = 2700 × 365 ÷ 395 = 2494.94元
```

**代码参考**：`PaymentRecordService.cs:437-467`

---

#### 6.5.2 期间金额计算

租金按自然月分期，每期的金额按实际使用天数比例计算。

**计算逻辑**：

1. **确定期间日期**：
   - 第一期：开始日期 = 起租日期，结束日期 = ClcEndDate（规则见下）
   - 中间期：开始日期 = 上期结束+1天，结束日期 = 该月最后一天
   - 最后一期：开始日期 = 上期结束+1天，结束日期 = 起租日期+租期月数-1天

2. **ClcEndDate 规则**：
   - 如果起租日期距离当月最后一天 < 5天，顺延到下月最后一天
   - 否则：当月最后一天

3. **计算期间金额**：
   - 遍历期间内的每个自然月
   - 计算每个月的实际使用天数
   - 本月租金 = 实际月租金 × 本月使用天数 ÷ 该月总天数
   - 累加所有月份的租金
   - 四舍五入保留2位小数，最小0.01元

**示例**：

假设：
- 起租日期：2025-01-15
- 租期：3个月
- 实际月租金：2500元

第一期：
- 开始：2025-01-15
- ClcEndDate：2025-01-31（距离月末16天，不顺延）
- 结束：2025-01-31
- 1月使用17天（15-31），1月总31天
- 金额：2500 × 17 ÷ 31 = 1370.97元

第二期：
- 开始：2025-02-01
- 结束：2025-02-28（2月最后一天）
- 2月使用28天，2月总28天
- 金额：2500 × 28 ÷ 28 = 2500.00元

第三期（最后一期）：
- 开始：2025-03-01
- 结束：2025-04-14（起租日期+3个月-1天）
- 3月使用31天，3月总31天
- 4月使用14天，4月总30天
- 金额：2500 × 31 ÷ 31 + 2500 × 14 ÷ 30 = 2500 + 1166.67 = 3666.67元

总金额：1370.97 + 2500.00 + 3666.67 = 7537.64元
验证：2500 × 3 = 7500元（接近，差异来自分期计算的舍入）

**代码参考**：`PaymentRecordService.cs:385-426`

---

#### 6.5.3 增配价格查询

增配价格从商品模板属性值表 (`ProductTemplateAttributeValue`) 查询。

**查询逻辑**：
1. 获取资产的商品实例属性值列表
2. 提取所有 `TemplateAttributeValueId`（不为 null）
3. 查询模板属性值表的 `Price` 字段
4. 累加所有价格得到增配总价

**代码参考**：`ProductTemplateService.cs:237-249`

---

### 6.6 定时任务规则

系统有三个定时任务，分别处理收款逾期、租期到期提醒和租期到期处理。

#### 6.6.1 收款单逾期检查

**执行频率**：每天一次（通常在凌晨）

**处理逻辑**：
1. 查询待支付的收款单
2. 筛选条件：预计收款日期 < 当前日期
3. 更新状态为"已逾期"
4. 发送钉钉通知

**代码参考**：`ZR.Tasks/TaskScheduler/Job_PaymentOverdue.cs`

---

#### 6.6.2 租期到期提醒

**执行频率**：每天一次

**处理逻辑**：
1. 计算提醒日期 = 当前日期 + N天（配置项）
2. 查询执行中的租期
3. 筛选条件：结束日期 = 提醒日期
4. 发送钉钉通知

**代码参考**：`ZR.Tasks/TaskScheduler/Job_LeaseExpirationReminder.cs`

---

#### 6.6.3 租期到期处理

**执行频率**：每天一次

**处理逻辑**：
1. 查询已到期的租期
2. 筛选条件：结束日期 < 当前日期 且 状态 = 执行中
3. 更新租期状态为"已完成"
4. 检查该销售单的所有租期：
   - 如果全部完成：销售单状态变为"已完成"
   - 如果还有执行中的租期：不变

**代码参考**：`ZR.Tasks/TaskScheduler/Job_LeaseExpiration.cs`

---

## 7. 异常处理流程

### 7.1 采购失败处理

如果采购失败（供应商无货、采购取消等），需要手动处理：

**处理步骤**：
1. 删除失败的采购单（只能删除未完成的）
2. 销售单仍保持"采购中"状态
3. 重新分配：
   - 选项1：分配其他闲置资产
   - 选项2：关联其他预采购单
   - 选项3：创建新的采购单
4. 如果全部满足：销售单自动流转为"待执行"

**注意事项**：
- 销售单创建的采购单不能手动删除（只能通过中止销售单）
- 预采购单如果已关联销售单也不能删除

---

### 7.2 客户取消订单

客户取消订单时，根据订单状态不同有不同的处理方式：

#### 7.2.1 待分配状态

**操作**：直接删除销售单

**影响**：
- 删除所有关联数据
- 不影响资产和采购单（尚未分配）

---

#### 7.2.2 采购中状态

**操作**：中止销售单

**影响**：
- 预采购单移除关联，保留订单
- 销售单创建的采购单被删除
- 已完成的采购单保留（资产已入库，变为闲置）

---

#### 7.2.3 待执行状态

**操作**：中止销售单

**影响**：
- 锁定的资产恢复为闲置
- 预采购单移除关联
- 销售单创建的采购单被删除

---

#### 7.2.4 执行中状态

**操作**：
- 选项1：全部退租后自动中止
- 选项2：手动中止（强制）

**影响**：
- 资产恢复为闲置
- 未来租金单被删除
- 已支付的租金不退款

---

### 7.3 设备故障处理

设备在租赁中出现故障需要维修或更换：

#### 7.3.1 维修流程

1. 如果是在租资产，不能直接修改状态
2. 需要先退租（资产变为闲置）
3. 手动更新资产状态为"维修"
4. 维修完成后，手动更新状态为"闲置"
5. 重新分配给新订单

**注意事项**：
- 退租会删除未来租金单
- 客户可能需要补偿或退款（业务层面）

---

#### 7.3.2 更换设备

1. 退租故障设备
2. 分配新设备给客户
3. 需要新增商品需求或修改现有需求
4. 重新执行订单

**推荐流程**：
- 创建新的销售单（推荐）
- 或者修改现有销售单的需求（复杂）

---

### 7.4 地址变更处理

#### 7.4.1 订单执行前

**操作**：直接修改销售单的收货地址

**影响**：
- 快照地址被更新
- 关联的采购单收到通知
- 采购人员手动决定是否需要调整采购单地址

**代码参考**：`SalesOrderService.cs:568-611`

---

#### 7.4.2 订单执行后

**操作**：手动更新资产地址

**影响**：
- 资产的实际位置发生变化
- 销售单的收货地址不变（快照）
- 需要记录地址变更日志

**代码参考**：`AssetService.cs:785-890`

---

### 7.5 价格调整处理

#### 7.5.1 订单执行前

**操作**：
1. 修改商品需求的单价和资源费
2. 修改押金/销售收款单的金额

**影响**：
- 后续的租金计算使用新价格
- 已生成的收款单不会自动更新

**代码参考**：`SalesOrderService.cs:1876-1909`

---

#### 7.5.2 订单执行后

**操作**：
- 修改未支付的租金单金额
- 系统会重新计算实际月租金

**影响**：
- 只影响未支付的租金单
- 已支付的不变

**代码参考**：`PaymentRecordService.cs:169-269`

---

### 7.6 系统并发冲突处理

系统在关键节点使用了并发控制机制：

#### 7.6.1 编号生成

- 使用互斥锁保证编号唯一性
- 锁的范围：整个生成流程

---

#### 7.6.2 资产编码

- 创建和修改时检查唯一性
- 采购完成时二次校验
- 如果冲突，抛出异常提示用户

---

#### 7.6.3 状态流转

- 使用数据库事务保证原子性
- 状态更新和日志记录同时成功或失败

---

## 8. 常见问题FAQ

### Q1: 销售单的快照机制是什么？为什么需要快照？

**答**：快照机制是指在创建销售单时，系统自动复制客户和收货地址的数据，作为该订单的专属副本。

**作用**：
- 保证历史订单数据的准确性，不受后续修改影响
- 客户信息或地址修改后，历史订单仍然显示当时的数据
- 便于查询和统计历史交易信息

**实现方式**：
- `IsSnapshot = true`：标记为快照数据
- `CreateBy = null`：快照数据没有创建人
- 不出现在用户的客户/地址列表中

---

### Q2: 为什么预采购单不能填写收货地址？

**答**：预采购单是提前采购的设备，创建时还不知道最终的客户和收货地址。

**流程**：
1. 创建预采购单（不填地址）
2. 采购完成，设备入库（状态：闲置）
3. 匹配销售单时，自动填入销售单的收货地址
4. 采购单完成后，资产地址 = 收货地址

**优点**：
- 提前采购常用设备，缩短交货周期
- 灵活匹配销售单

---

### Q3: 商品分配时，为什么需要验证分配数量等于需求数量？

**答**：保证订单的完整性和准确性。

**原因**：
- 每个需求都有明确的数量要求
- 分配不足：无法满足客户需求
- 分配过多：浪费资源，数据不一致

**验证时机**：提交分配时统一验证

---

### Q4: 租金是如何计算的？为什么要这么复杂？

**答**：租金计算考虑了多个因素，确保公平和准确。

**考虑因素**：
1. **赠送天数**：客户实际使用时间更长，但收租天数不变
2. **增配价格**：设备配置升级的成本分摊到租期
3. **资源费**：额外的服务成本

**复杂性原因**：
- 按自然月分期，每月天数不同
- 第一期和最后一期可能不是完整月份
- 需要按实际使用天数比例计算

**公平性**：
- 客户按实际使用天数付费
- 公司按实际收租天数收租
- 赠送天数通过调整实际月租金实现

---

### Q5: 采购单为什么只能顺序流转？不能跳过状态吗？

**答**：采购单的状态代表采购流程的实际进度，必须按顺序执行。

**状态含义**：
- **待下单**：需要向供应商下单
- **已下单**：已下单，等待供应商发货
- **已完成**：货物到达，入库

**顺序原因**：
- 确保每个步骤都经过审核
- 记录完整的采购历史
- 避免遗漏关键环节

**例外情况**：
- 手动创建的采购单默认"已下单"（假设已经下单）
- 销售单创建的采购单默认"待下单"（需要审核）

---

### Q6: 中止销售单后，采购单和资产会怎么处理？

**答**：根据采购单类型和状态不同，处理方式不同。

**采购单处理**：
- **预采购单**：移除关联，保留采购单（可匹配其他销售单）
- **销售单创建的采购单（未完成）**：删除采购单
- **销售单创建的采购单（已完成）**：保留采购单（资产已入库）

**资产处理**：
- 未退租的资产状态恢复为"闲置"
- 可以重新分配给其他销售单

**租金单处理**：
- 删除未来的租金单（未支付或已逾期）
- 已支付的租金单保留

---

### Q7: 退租和中止销售单有什么区别？

**答**：退租是局部操作，中止是全局操作。

**退租（单个资产）**：
- 操作对象：单个资产
- 适用场景：客户不再需要某个设备
- 影响：
  - 该资产变为闲置
  - 删除该资产的未来租金单
  - 销售单仍然执行中（如果还有其他资产）
- 触发条件：手动操作
- 后续影响：如果全部退租，自动触发中止销售单

**中止销售单（整个订单）**：
- 操作对象：整个销售单
- 适用场景：订单取消或异常
- 影响：
  - 所有未退租资产变为闲置
  - 删除所有未来租金单
  - 处理关联的采购单
  - 租期状态变为已取消
  - 销售单状态变为已取消
- 触发条件：手动操作或全部退租
- 后续影响：订单终结，不可恢复

---

### Q8: 为什么修改销售单收货地址后，关联的采购单会收到通知？

**答**：提醒采购人员注意地址变更，及时调整采购计划。

**场景**：
- 销售单状态：采购中
- 收货地址：发生变更
- 采购单：可能正在采购或等待发货

**影响**：
- 采购单的收货地址可能需要同步更新
- 如果货物已发往旧地址，需要协调变更

**通知内容**：
- 销售单编号
- 关联采购单编号
- 新收货地址

**代码参考**：`SalesOrderService.cs:568-611`

---

### Q9: 资产升级版本是什么意思？如何使用？

**答**：资产升级版本是指设备的配置或规格发生变化，需要更新资产的商品实例。

**适用场景**：
- 硬件升级（如内存、硬盘）
- 软件升级（如操作系统版本）
- 配置调整

**操作流程**：
1. 选择目标资产
2. 选择新的商品模板或修改属性
3. 系统对比新旧配置
4. 确认升级
5. 系统创建新的商品实例
6. 更新资产的 `ProductInstanceId`
7. 记录升级日志

**历史保留**：
- 旧的商品实例保留（不删除）
- 可以查看升级历史

**代码参考**：`AssetService.cs:1080-1146`

---

### Q10: 系统的定时任务多久执行一次？如何配置？

**答**：定时任务使用 Quartz.NET 调度，可以在配置文件中设置。

**默认执行频率**：
- 收款单逾期检查：每天凌晨1点
- 租期到期提醒：每天早上8点
- 租期到期处理：每天凌晨2点

**配置方式**：
- 在 `appsettings.json` 中配置 Cron 表达式
- 修改后需要重启服务

**示例**：
```json
{
  "QuartzJobs": {
    "PaymentOverdue": "0 0 1 * * ?",     // 每天1点
    "LeaseReminder": "0 0 8 * * ?",      // 每天8点
    "LeaseExpiration": "0 0 2 * * ?"     // 每天2点
  }
}
```

---

## 附录

### A. 术语表

| 术语 | 英文 | 说明 |
|-----|------|-----|
| 销售单 | SalesOrder | 客户的购买或租赁订单 |
| 商品需求 | ProductDemand | 订单中的商品明细 |
| 采购单 | PurchaseOrder | 向供应商采购设备的订单 |
| 资产 | Asset | 公司的库存设备 |
| 租期 | LeasePeriod | 租赁业务的租赁期限 |
| 收款单 | PaymentRecord | 收款记录 |
| 快照 | Snapshot | 数据的历史副本 |
| 商品实例 | ProductInstance | 商品的具体配置 |
| 商品模板 | ProductTemplate | 商品的基础信息和属性定义 |
| 属性哈希 | AttributeHash | 用于匹配商品规格的哈希值 |

---

### B. 相关文档

- [业务流程图](./业务流程图.md)：包含所有 Mermaid 流程图
- [架构优化建议](./架构优化建议.md)：循环依赖解决方案
- [数据字典](./数据字典.md)：所有实体和字段说明
- [操作权限矩阵](./操作权限矩阵.md)：状态与操作的关系

---

### C. 代码导航

**核心服务**：
- 销售单：`ZR.Service/Sales/SalesOrderService.cs`
- 采购单：`ZR.Service/Purchase/PurchaseOrderService.cs`
- 资产：`ZR.Service/AssetNS/AssetService.cs`
- 租期：`ZR.Service/Sales/LeasePeriodService.cs`
- 收款单：`ZR.Service/Sales/PaymentRecordService.cs`

**状态枚举**：
- 销售单状态：`ZR.Model/Sales/Enums/SalesStatus.cs`
- 采购单状态：`ZR.Model/Purchase/Enums/PurchaseStatus.cs`
- 资产状态：`ZR.Model/AssetNS/Enums/AssetStatus.cs`
- 租期状态：`ZR.Model/Sales/Enums/LeaseStatus.cs`
- 收款状态：`ZR.Model/Sales/Enums/PaymentStatus.cs`

**定时任务**：
- 收款逾期：`ZR.Tasks/TaskScheduler/Job_PaymentOverdue.cs`
- 租期提醒：`ZR.Tasks/TaskScheduler/Job_LeaseExpirationReminder.cs`
- 租期到期：`ZR.Tasks/TaskScheduler/Job_LeaseExpiration.cs`

---

**文档版本**: 1.0  
**最后更新**: 2025-01-26  
**维护人**: 开发团队

