# 采销库存系统 - 操作权限矩阵

## 目录

- [1. 销售单操作权限矩阵](#1-销售单操作权限矩阵)
- [2. 采购单操作权限矩阵](#2-采购单操作权限矩阵)
- [3. 资产操作权限矩阵](#3-资产操作权限矩阵)
- [4. 商品需求操作权限](#4-商品需求操作权限)
- [5. 租期管理操作权限](#5-租期管理操作权限)
- [6. 收款单操作权限](#6-收款单操作权限)
- [7. 操作触发的状态变更](#7-操作触发的状态变更)

---

## 1. 销售单操作权限矩阵

### 1.1 销售单字段修改权限

| 字段名 | 待分配 | 采购中 | 待执行 | 执行中 | 已完成 | 已取消 | 说明 |
|-------|--------|--------|--------|--------|--------|--------|------|
| 客户信息 | ✅ | ✅ | ✅ | ❌ | ❌ | ❌ | 修改会更新快照内容 |
| 收货地址 | ✅ | ✅ | ✅ | ❌ | ❌ | ❌ | 修改会更新快照，采购中状态会通知采购人员 |
| 业务类型 | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ | 一旦创建不可修改 |
| 押金金额 | ✅ | ✅ | ✅ | ❌ | ❌ | ❌ | 需同步修改收款单 |
| 商品需求 | ✅ | ✅ | ❌ | ❌ | ❌ | ❌ | 待执行后不可修改（已分配资产） |
| 备注 | ✅ | ✅ | ✅ | ✅ | ❌ | ❌ | 随时可修改 |

**图例**：
- ✅ 可以修改
- ❌ 不可修改
- ⚠️ 有条件限制

---

### 1.2 销售单操作权限

| 操作 | 待分配 | 采购中 | 待执行 | 执行中 | 已完成 | 已取消 | 说明 |
|-----|--------|--------|--------|--------|--------|--------|------|
| **查看详情** | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | 所有状态均可查看 |
| **编辑基本信息** | ✅ | ✅ | ✅ | ❌ | ❌ | ❌ | 执行后不可编辑 |
| **删除** | ✅ | ❌ | ❌ | ❌ | ❌ | ❌ | 只能删除待分配状态 |
| **商品分配** | ✅ | ❌ | ❌ | ❌ | ❌ | ❌ | 只能在待分配时操作 |
| **修改需求价格** | ✅ | ✅ | ✅ | ❌ | ❌ | ❌ | 执行前可修改 |
| **修改租期信息** | ❌ | ❌ | ✅ | ❌ | ❌ | ❌ | 只能在待执行时修改 |
| **执行订单** | ❌ | ❌ | ⚠️ | ❌ | ❌ | ❌ | 需满足：押金/销售款已支付 |
| **退租资产** | ❌ | ❌ | ❌ | ✅ | ❌ | ❌ | 只能在执行中操作 |
| **中止订单** | ❌ | ✅ | ✅ | ✅ | ❌ | ❌ | 待分配、已完成、已取消不能中止 |
| **查看状态日志** | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | 所有状态均可查看 |
| **查看订单管理** | ❌ | ✅ | ✅ | ✅ | ✅ | ✅ | 分配后可查看 |

**特殊说明**：

**商品分配**：
- 必须为每个需求分配足够数量的资产/采购单
- 可混合使用：闲置资产 + 预采购单 + 新建采购单
- 分配完成后自动生成押金/销售收款单

**执行订单前置条件**：
1. 销售单状态 = 待执行
2. 押金/销售款已支付
3. 所有需求已分配资产

**中止订单影响**：
- 恢复资产为闲置状态
- 移除预采购单关联
- 删除销售单创建的采购单
- 删除未来租金单
- 租期状态变为已取消

---

## 2. 采购单操作权限矩阵

### 2.1 采购单字段修改权限

| 字段名 | 待下单 | 已下单 | 已完成 | 说明 |
|-------|--------|--------|--------|------|
| 商品模板 | ❌ | ❌ | ❌ | 创建后不可修改 |
| 商品属性 | ✅ | ✅ | ❌ | 完成前可修改 |
| 预采购标志 | ⚠️ | ⚠️ | ❌ | 未关联销售单时可修改 |
| 收货地址 | ⚠️ | ⚠️ | ❌ | 预采购单不可填写地址 |
| 资产编码 | ✅ | ✅ | ❌ | 完成前可修改，需检查唯一性 |
| 备注 | ✅ | ✅ | ❌ | 完成前可修改 |

**特殊约束**：

**预采购标志修改限制**：
- 已关联销售单：不可修改
- 销售单创建的采购单：不可修改为预采购单

**收货地址填写限制**：
- 预采购单：不允许填写（匹配销售单后自动填入）
- 销售单创建的采购单：使用销售单地址
- 手动创建的普通采购单：可以填写

---

### 2.2 采购单操作权限

| 操作 | 待下单 | 已下单 | 已完成 | 说明 |
|-----|--------|--------|--------|------|
| **查看详情** | ✅ | ✅ | ✅ | 所有状态均可查看 |
| **编辑** | ✅ | ✅ | ❌ | 完成后不可编辑 |
| **删除** | ⚠️ | ⚠️ | ❌ | 条件见下方说明 |
| **流转到已下单** | ✅ | ❌ | ❌ | 只能从待下单流转 |
| **流转到已完成** | ❌ | ⚠️ | ❌ | 需满足完成条件 |
| **查看状态日志** | ✅ | ✅ | ✅ | 所有状态均可查看 |
| **关联到销售单** | ⚠️ | ⚠️ | ❌ | 仅预采购单可关联 |

**删除条件**（必须全部满足）：
1. 采购来源 = 手动创建
2. 采购状态 ≠ 已完成
3. 未关联销售单

**流转到已完成前置条件**：
1. 收货地址完整（省份、城市、详细地址都必填）
2. 资产编码已填写
3. 资产编码唯一（不与现有资产和采购单冲突）

**流转到已完成触发操作**：
1. 创建资产记录
2. 回填资产ID到采购单
3. 如果关联销售单：
   - 创建需求-资产关联
   - 检查销售单需求是否全部满足
   - 如果满足：创建租期、更新销售单状态为待执行、发送通知

---

### 2.3 采购单状态流转规则

| 当前状态 | 可流转到 | 不可流转到 | 说明 |
|---------|---------|-----------|------|
| 待下单 | 已下单 | 已完成 | 只能顺序流转 |
| 已下单 | 已完成 | 待下单 | 不能回退 |
| 已完成 | - | 任何状态 | 终态，不可再流转 |

---

## 3. 资产操作权限矩阵

### 3.1 资产字段修改权限

| 字段名 | 闲置 | 在租 | 锁定 | 维修 | 售出 | 报废 | 说明 |
|-------|-----|------|------|------|------|------|------|
| 资产编码 | ⚠️ | ❌ | ❌ | ⚠️ | ❌ | ❌ | 需检查唯一性 |
| 商品属性 | ✅ | ❌ | ❌ | ✅ | ❌ | ❌ | 非租用状态可修改 |
| 地址信息 | ✅ | ⚠️ | ✅ | ✅ | ❌ | ❌ | 在租状态地址由系统管理 |
| 责任人 | ✅ | ✅ | ✅ | ✅ | ❌ | ❌ | 可用状态均可修改 |
| 备注 | ✅ | ✅ | ✅ | ✅ | ❌ | ❌ | 可用状态均可修改 |

---

### 3.2 资产操作权限

| 操作 | 闲置 | 在租 | 锁定 | 维修 | 售出 | 报废 | 说明 |
|-----|-----|------|------|------|------|------|------|
| **查看详情** | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | 所有状态均可查看 |
| **编辑基本信息** | ✅ | ⚠️ | ⚠️ | ✅ | ❌ | ❌ | 部分字段有限制 |
| **删除** | ✅ | ❌ | ❌ | ❌ | ❌ | ❌ | 只能删除闲置且未关联订单的资产 |
| **分配到销售单** | ✅ | ❌ | ❌ | ❌ | ❌ | ❌ | 只能分配闲置资产 |
| **手动更新状态** | ✅ | ❌ | ❌ | ✅ | ❌ | ❌ | 在租、锁定由系统自动管理 |
| **更新地址** | ✅ | ❌ | ✅ | ✅ | ❌ | ❌ | 在租状态地址由订单执行时更新 |
| **升级版本** | ✅ | ❌ | ✅ | ✅ | ❌ | ❌ | 修改商品实例 |
| **查看状态日志** | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | 所有状态均可查看 |
| **查看地址日志** | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | 所有状态均可查看 |

---

### 3.3 资产状态流转规则

| 当前状态 | 可手动流转到 | 系统自动流转到 | 说明 |
|---------|------------|--------------|------|
| 闲置 | 维修、报废 | 锁定 | 分配到销售单时自动锁定 |
| 在租 | - | 闲置 | 退租时自动变为闲置 |
| 锁定 | - | 在租、售出、闲置 | 执行订单或中止时自动流转 |
| 维修 | 闲置 | - | 维修完成手动改为闲置 |
| 售出 | - | - | 终态 |
| 报废 | - | - | 终态 |

**说明**：
- **手动流转**：通过"更新资产状态"操作手动修改
- **系统自动流转**：在订单流程中由系统自动触发

---

## 4. 商品需求操作权限

### 4.1 商品需求修改权限

| 操作 | 销售单状态 | 说明 |
|-----|-----------|------|
| **添加需求** | 待分配、采购中 | 待执行后不可添加 |
| **删除需求** | 待分配、采购中 | 待执行后不可删除 |
| **修改商品配置** | 待分配、采购中 | 待执行后不可修改 |
| **修改数量** | 待分配、采购中 | 待执行后不可修改 |
| **修改单价** | 待分配、采购中、待执行 | 执行前可修改 |
| **修改资源费** | 待分配、采购中、待执行 | 执行前可修改 |
| **修改租期月数** | 待分配、采购中、待执行 | 执行前可修改 |

**说明**：
- 商品需求通过销售单编辑页面修改
- 待执行状态后，商品配置已确定（资产已分配），不可再修改配置和数量
- 但价格和租期可以调整（影响后续租金计算）

---

## 5. 租期管理操作权限

### 5.1 租期信息修改权限

| 字段名 | 待执行 | 执行中 | 已完成 | 已取消 | 说明 |
|-------|--------|--------|--------|--------|------|
| 起租日期 | ✅ | ❌ | ❌ | ❌ | 只能在待执行时修改 |
| 赠送天数 | ✅ | ❌ | ❌ | ❌ | 只能在待执行时修改 |
| 赠送天数前置 | ✅ | ❌ | ❌ | ❌ | 只能在待执行时修改 |
| 结束日期 | ⚠️ | ❌ | ❌ | ❌ | 根据其他参数自动计算 |

**说明**：
- 租期信息在销售单"待执行"状态时可以修改
- 执行订单后不可修改（已生成租金单）
- 结束日期由系统自动计算，不可直接修改

---

### 5.2 租期操作权限

| 操作 | 待执行 | 执行中 | 已完成 | 已取消 | 说明 |
|-----|--------|--------|--------|--------|------|
| **查看租期信息** | ✅ | ✅ | ✅ | ✅ | 所有状态均可查看 |
| **修改租期信息** | ✅ | ❌ | ❌ | ❌ | 只能在待执行时修改 |
| **计算租期结束日期** | ✅ | ✅ | ✅ | ✅ | 任何时候可以计算 |

---

## 6. 收款单操作权限

### 6.1 收款单修改权限（按收款类型）

#### 6.1.1 押金/销售收款单

| 操作 | 待支付 | 已收款 | 已逾期 | 说明 |
|-----|--------|--------|--------|------|
| **修改金额** | ✅ | ❌ | ✅ | 支付前可修改 |
| **标记已收款** | ✅ | ❌ | ✅ | 更新状态并记录实际收款日期 |
| **查看详情** | ✅ | ✅ | ✅ | 所有状态均可查看 |

---

#### 6.1.2 租金收款单

| 操作 | 待支付 | 已收款 | 已逾期 | 说明 |
|-----|--------|--------|--------|------|
| **修改应收金额** | ✅ | ❌ | ✅ | 支付前可修改，会重新计算实际月租金 |
| **标记已收款** | ✅ | ❌ | ✅ | 更新状态并记录实际收款日期 |
| **查看详情** | ✅ | ✅ | ✅ | 所有状态均可查看 |
| **删除** | ⚠️ | ❌ | ⚠️ | 退租或中止时系统自动删除未来租金单 |

**特殊说明**：

**修改租金单金额的影响**：
1. 直接修改 `expected_amount`（应收金额）
2. 系统重新计算 `actual_price`（实际月租金）
3. 计算公式保持不变，但用新的应收金额作为输入

**自动删除规则**：
- 退租或中止销售单时
- 删除条件：期间开始日期 > 当前日期 且 状态 = 待支付或已逾期
- 已支付的租金单不会删除

---

### 6.2 收款单操作权限（按销售单状态）

| 收款类型 | 销售单状态 | 可修改金额 | 可收款 | 说明 |
|---------|-----------|----------|--------|------|
| 押金 | 待分配 | - | - | 尚未生成 |
| 押金 | 采购中、待执行 | ✅ | ✅ | 可修改和收款 |
| 押金 | 执行中、已完成 | ❌ | ⚠️ | 不可修改，未支付可补收款 |
| 销售 | 待分配 | - | - | 尚未生成 |
| 销售 | 采购中、待执行 | ✅ | ✅ | 可修改和收款 |
| 销售 | 已完成 | ❌ | ⚠️ | 不可修改，未支付可补收款 |
| 租金 | 待分配、采购中、待执行 | - | - | 尚未生成 |
| 租金 | 执行中 | ⚠️ | ✅ | 未支付可修改 |
| 租金 | 已完成、已取消 | ❌ | ⚠️ | 不可修改，未支付可补收款 |

---

## 7. 操作触发的状态变更

### 7.1 销售单状态自动变更触发条件

| 触发操作 | 前置状态 | 后置状态 | 触发条件 |
|---------|---------|---------|---------|
| 提交商品分配 | 待分配 | 采购中 | 分配了采购单（预采购或新建） |
| 提交商品分配 | 待分配 | 待执行 | 全部分配闲置资产 |
| 采购单完成 | 采购中 | 待执行 | 所有关联采购单都已完成 |
| 执行订单 | 待执行 | 执行中 | 租赁/以租代售业务 |
| 执行订单 | 待执行 | 已完成 | 销售业务 |
| 租期到期 | 执行中 | 已完成 | 所有租期都已到期 |
| 全部退租 | 执行中 | 已取消 | 所有资产都已退租 |
| 手动中止 | 采购中/待执行/执行中 | 已取消 | 手动操作 |

---

### 7.2 采购单状态自动变更触发条件

| 触发操作 | 前置状态 | 后置状态 | 触发条件 |
|---------|---------|---------|---------|
| 手动流转 | 待下单 | 已下单 | 手动操作 |
| 手动流转 | 已下单 | 已完成 | 验证通过后手动操作 |

---

### 7.3 资产状态自动变更触发条件

| 触发操作 | 前置状态 | 后置状态 | 触发条件 |
|---------|---------|---------|---------|
| 分配到销售单 | 闲置 | 锁定 | 商品分配时 |
| 执行订单（租赁） | 锁定 | 在租 | 销售单执行时 |
| 执行订单（销售） | 锁定 | 售出 | 销售单执行时 |
| 退租 | 在租 | 闲置 | 退租操作 |
| 销售单中止 | 锁定 | 闲置 | 中止销售单时 |
| 采购完成（有销售单） | - | 锁定 | 采购单完成且关联销售单 |
| 采购完成（无销售单） | - | 闲置 | 采购单完成且未关联销售单 |

---

### 7.4 租期状态自动变更触发条件

| 触发操作 | 前置状态 | 后置状态 | 触发条件 |
|---------|---------|---------|---------|
| 执行订单 | 待执行 | 执行中 | 销售单执行时 |
| 租期到期 | 执行中 | 已完成 | 定时任务检查到期 |
| 销售单中止 | 待执行/执行中 | 已取消 | 中止销售单时 |

---

### 7.5 收款单状态自动变更触发条件

| 触发操作 | 前置状态 | 后置状态 | 触发条件 |
|---------|---------|---------|---------|
| 手动收款 | 待支付 | 已收款 | 手动标记已收款 |
| 手动收款 | 已逾期 | 已收款 | 手动标记已收款 |
| 定时检查 | 待支付 | 已逾期 | 当前日期 > 预计收款日期 |

---

## 8. 操作权限总结

### 8.1 关键操作权限要求

| 操作 | 前置条件 | 后置影响 | 不可逆性 |
|-----|---------|---------|---------|
| **创建销售单** | 客户、地址信息完整 | 生成快照、创建商品实例 | 可删除（仅待分配） |
| **商品分配** | 待分配状态 | 生成收款单、可能创建采购单 | 不可撤销，只能中止 |
| **完成采购单** | 地址完整、资产编码唯一 | 创建资产、可能更新销售单状态 | 不可逆 |
| **执行订单** | 待执行状态、押金/销售款已支付 | 生成租金单、更新资产状态 | 不可逆 |
| **退租** | 执行中状态 | 删除未来租金单、恢复资产 | 不可逆 |
| **中止销售单** | 非待分配/已完成/已取消 | 恢复资产、处理采购单、取消租期 | 不可逆 |

---

### 8.2 数据修改窗口期

| 数据类型 | 可修改时期 | 锁定时机 | 说明 |
|---------|-----------|---------|------|
| **销售单基本信息** | 创建 → 执行前 | 执行订单 | 执行后数据固化 |
| **商品需求配置** | 创建 → 分配前 | 商品分配 | 分配后配置固化 |
| **商品需求价格** | 创建 → 执行前 | 执行订单 | 执行后价格固化 |
| **租期信息** | 分配后 → 执行前 | 执行订单 | 执行后租期固化 |
| **收款单金额** | 生成 → 支付前 | 标记已收款 | 支付后金额固化 |
| **采购单配置** | 创建 → 完成前 | 采购完成 | 完成后配置固化 |
| **资产配置** | 创建 → 分配前 | 分配或在租 | 租用中不可修改 |

---

### 8.3 不同角色的典型权限（建议）

| 操作 | 销售人员 | 采购人员 | 仓库人员 | 财务人员 | 管理员 |
|-----|---------|---------|---------|---------|--------|
| **创建销售单** | ✅ | ❌ | ❌ | ❌ | ✅ |
| **编辑销售单** | ✅ | ❌ | ❌ | ❌ | ✅ |
| **商品分配** | ✅ | ❌ | ✅ | ❌ | ✅ |
| **执行订单** | ✅ | ❌ | ✅ | ❌ | ✅ |
| **退租操作** | ✅ | ❌ | ✅ | ❌ | ✅ |
| **中止销售单** | ⚠️ | ❌ | ❌ | ❌ | ✅ |
| **创建采购单** | ❌ | ✅ | ❌ | ❌ | ✅ |
| **编辑采购单** | ❌ | ✅ | ❌ | ❌ | ✅ |
| **采购状态流转** | ❌ | ✅ | ❌ | ❌ | ✅ |
| **创建资产** | ❌ | ❌ | ✅ | ❌ | ✅ |
| **编辑资产** | ❌ | ❌ | ✅ | ❌ | ✅ |
| **收款操作** | ⚠️ | ❌ | ❌ | ✅ | ✅ |
| **修改收款单金额** | ❌ | ❌ | ❌ | ✅ | ✅ |

**图例**：
- ✅ 建议授权
- ❌ 不建议授权
- ⚠️ 需要审批

---

## 9. 常见场景权限问题FAQ

### Q1: 为什么执行订单后不能修改销售单信息？

**答**：执行订单后，已经生成租金单、更新资产状态、资产已发往客户。此时修改订单信息会导致：
- 租金单与订单信息不一致
- 资产实际状态与记录不符
- 历史数据混乱

**解决方案**：
- 执行前仔细核对信息
- 如需修改，必须先中止订单，修改后重新执行

---

### Q2: 为什么待执行状态不能修改商品需求配置？

**答**：待执行状态表示资产已全部分配完成，商品配置已确定。如果修改配置：
- 已分配的资产可能不匹配新配置
- 需要重新分配资产
- 采购单可能已经完成

**解决方案**：
- 如需修改配置，先中止订单
- 修改配置后重新进行商品分配

**允许的修改**：
- 可以修改单价和资源费（不影响已分配的资产）

---

### Q3: 为什么预采购单不能填写收货地址？

**答**：预采购单是提前采购的设备，创建时还不知道最终客户和收货地址。

**流程**：
1. 创建预采购单（不填地址）
2. 采购完成，设备入库（状态：闲置）
3. 匹配销售单时，自动填入销售单的收货地址
4. 采购完成后，资产继承采购单的收货地址

---

### Q4: 为什么在租状态的资产不能修改配置？

**答**：在租状态表示资产已经租给客户使用，实际设备在客户手中。如果修改配置：
- 系统记录与实际设备不符
- 租金计算可能出错
- 客户合同与系统不一致

**解决方案**：
- 如果设备实际发生变化（如升级硬件），应先退租
- 修改资产配置或创建新资产
- 重新出租

---

### Q5: 为什么采购单只能顺序流转，不能跳过状态？

**答**：采购单的状态代表采购流程的实际进度：
- 待下单：需要审核和下单
- 已下单：等待供应商发货
- 已完成：货物到达，入库

跳过状态会导致：
- 流程不规范，缺少审核环节
- 历史记录不完整
- 无法追溯采购过程

---

### Q6: 为什么中止销售单操作不可逆？

**答**：中止销售单会执行一系列操作：
- 删除未来租金单
- 恢复资产状态
- 处理采购单（移除关联或删除）
- 更新租期状态

这些操作涉及多个实体和状态变更，无法简单回滚。

**建议**：
- 中止前确认操作
- 如果误操作，只能创建新的销售单

---

### Q7: 收款单的金额修改为什么会重新计算实际月租金？

**答**：对于租金单，修改应收金额相当于调整了月租金单价，需要重新计算实际月租金以保证：
- 租金计算的一致性
- 赠送天数的正确折算
- 增配价格和资源费的正确扣除

**计算逻辑**：
- 使用新的应收金额作为月租金单价
- 重新应用租金计算公式
- 更新 `actual_price` 字段

---

### Q8: 为什么销售单在采购中状态修改收货地址会发送通知？

**答**：采购中状态表示采购单可能正在采购或等待发货，如果收货地址变更：
- 可能需要调整发货地址
- 采购人员需要及时知晓
- 避免货物发错地址

**通知内容**：
- 销售单编号
- 关联采购单编号
- 新收货地址

**采购人员收到通知后**：
- 检查采购单状态
- 如果尚未发货，更新采购单地址
- 如果已发货，协调地址变更

---

## 附录

### A. 权限配置建议

建议在系统中实现基于角色的访问控制（RBAC）：

1. **角色定义**：
   - 销售人员、采购人员、仓库人员、财务人员、管理员

2. **权限粒度**：
   - 模块级别：销售管理、采购管理、资产管理
   - 操作级别：查看、创建、编辑、删除、审核
   - 数据级别：本人数据、部门数据、全部数据

3. **特殊权限**：
   - 中止销售单：需要管理员权限或审批
   - 修改已支付收款单：需要财务主管权限
   - 删除资产：需要仓库主管权限

---

### B. 审计日志建议

所有关键操作都应记录审计日志：

1. **状态变更**：
   - 销售单状态、采购单状态、资产状态、租期状态、收款状态

2. **重要操作**：
   - 商品分配、执行订单、退租、中止、收款

3. **数据修改**：
   - 修改价格、修改租期、修改配置

4. **日志内容**：
   - 操作人、操作时间、操作内容、前值、后值、操作原因

---

**文档版本**: 1.0  
**最后更新**: 2025-01-26  
**维护人**: 开发团队

