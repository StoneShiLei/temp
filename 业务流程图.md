# 采销库存系统 - 业务流程图

本文档包含采销库存系统的各类流程图，使用 Mermaid 语法绘制，可以在支持 Mermaid 的 Markdown 查看器中直接渲染。

---

## 1. 主业务流程图

### 1.1 销售单完整生命周期

```mermaid
flowchart TD
    Start([开始：创建销售单]) --> CreateOrder[创建销售单<br/>状态: 待分配]
    CreateOrder --> CreateSnapshot[创建客户和地址快照]
    CreateSnapshot --> CreateDemands[创建商品需求]
    CreateDemands --> StatusPendingAllocation{销售单状态<br/>待分配}
    
    StatusPendingAllocation --> AllocateProduct[商品分配]
    
    AllocateProduct --> CheckAllocation{分配方式判断}
    CheckAllocation -->|分配闲置资产| AllocateAsset[资产状态: 闲置 → 锁定]
    CheckAllocation -->|关联预采购单| LinkPrePurchase[关联预采购单<br/>更新收货地址]
    CheckAllocation -->|创建新采购单| CreatePurchase[创建采购单<br/>状态: 待下单]
    
    AllocateAsset --> CheckHasPurchase{是否有采购单?}
    LinkPrePurchase --> StatusPurchasing
    CreatePurchase --> StatusPurchasing
    
    CheckHasPurchase -->|是| StatusPurchasing[销售单状态: 采购中]
    CheckHasPurchase -->|否| StatusPendingExec1[销售单状态: 待执行]
    
    StatusPurchasing --> WaitPurchase[等待采购完成]
    WaitPurchase --> PurchaseComplete[采购单完成<br/>生成资产]
    PurchaseComplete --> CreateAsset[资产状态: 锁定<br/>创建需求-资产关联]
    CreateAsset --> CheckAllComplete{所有需求<br/>是否满足?}
    CheckAllComplete -->|否| WaitPurchase
    CheckAllComplete -->|是| CreateLease[创建租期管理数据]
    CreateLease --> StatusPendingExec2[销售单状态: 待执行]
    
    StatusPendingExec1 --> CheckPayment{押金/销售款<br/>是否支付?}
    StatusPendingExec2 --> CheckPayment
    CheckPayment -->|否| WaitPayment[等待支付]
    WaitPayment --> CheckPayment
    
    CheckPayment -->|是| ExecuteOrder[执行订单]
    
    ExecuteOrder --> CheckBusinessType{业务类型?}
    CheckBusinessType -->|销售| SoldFlow[资产状态: 售出<br/>销售单状态: 已完成]
    CheckBusinessType -->|租赁/以租代售| RentalFlow[资产状态: 在租<br/>销售单状态: 执行中]
    
    SoldFlow --> End1([结束])
    
    RentalFlow --> UpdateAssetLocation[更新资产地址]
    UpdateAssetLocation --> UpdateLeaseStatus[租期状态: 执行中]
    UpdateLeaseStatus --> GenerateRentPayments[生成分期租金收款单]
    GenerateRentPayments --> InExecution[租赁执行中]
    
    InExecution --> RentalProcess{租期管理}
    RentalProcess -->|按期收租| CollectRent[收租]
    CollectRent --> RentalProcess
    RentalProcess -->|退租| ReturnAsset[退租资产<br/>资产状态: 闲置<br/>删除未来租金单]
    ReturnAsset --> CheckRemaining{是否还有<br/>未退租资产?}
    CheckRemaining -->|是| InExecution
    CheckRemaining -->|否| AutoCancel[自动中止销售单]
    
    RentalProcess -->|租期到期| LeaseExpired[租期状态: 已完成<br/>销售单状态: 已完成]
    LeaseExpired --> End2([结束])
    
    StatusPendingAllocation -->|手动中止| CancelOrder
    StatusPurchasing -->|手动中止| CancelOrder
    StatusPendingExec1 -->|手动中止| CancelOrder
    StatusPendingExec2 -->|手动中止| CancelOrder
    InExecution -->|手动中止| CancelOrder
    AutoCancel --> CancelOrder[中止销售单]
    
    CancelOrder --> RestoreAsset[恢复资产: 闲置<br/>删除未来租金单<br/>租期状态: 已取消]
    RestoreAsset --> HandlePurchase[处理关联采购单]
    HandlePurchase --> CheckPurchaseType{采购单类型?}
    CheckPurchaseType -->|预采购单| RemoveRelation[移除关联<br/>置空地址]
    CheckPurchaseType -->|销售单创建| DeletePurchase[删除采购单]
    RemoveRelation --> StatusCancelled[销售单状态: 已取消]
    DeletePurchase --> StatusCancelled
    StatusCancelled --> End3([结束])
```

---

## 2. 商品分配流程图

```mermaid
flowchart TD
    Start([开始：商品分配]) --> CheckStatus{销售单状态}
    CheckStatus -->|不是待分配| Error1[错误: 只有待分配状态<br/>才能分配商品]
    CheckStatus -->|待分配| LoopDemands[遍历每个商品需求]
    
    LoopDemands --> CheckQuantity{分配数量<br/>= 需求数量?}
    CheckQuantity -->|否| Error2[错误: 分配数量不匹配]
    CheckQuantity -->|是| ProcessAllocation[处理分配]
    
    ProcessAllocation --> HasAssets{有分配资产?}
    HasAssets -->|是| ValidateAssets[验证资产状态<br/>必须是闲置]
    ValidateAssets --> UpdateAssetStatus[资产状态: 锁定]
    UpdateAssetStatus --> CreateAssetRelation[创建需求-资产关联]
    CreateAssetRelation --> NextCheck1
    HasAssets -->|否| NextCheck1{有预采购单?}
    
    NextCheck1 -->|是| ValidatePrePurchase[验证预采购单<br/>未关联其他销售单]
    ValidatePrePurchase --> UpdateAddress[更新预采购单收货地址]
    UpdateAddress --> CreatePurchaseRelation[创建需求-采购单关联]
    CreatePurchaseRelation --> SetHasPurchase[标记: 有采购单]
    SetHasPurchase --> NextCheck2
    NextCheck1 -->|否| NextCheck2{需要创建采购单?}
    
    NextCheck2 -->|是| CopyProductInstance[复制商品实例]
    CopyProductInstance --> CreateNewPurchase[创建新采购单<br/>状态: 待下单]
    CreateNewPurchase --> CreateNewRelation[创建需求-采购单关联]
    CreateNewRelation --> SetHasPurchase2[标记: 有采购单]
    SetHasPurchase2 --> CheckMoreDemands
    NextCheck2 -->|否| CheckMoreDemands{还有需求?}
    
    CheckMoreDemands -->|是| LoopDemands
    CheckMoreDemands -->|否| DetermineStatus{有采购单?}
    
    DetermineStatus -->|是| UpdateToPurchasing[销售单状态: 采购中]
    DetermineStatus -->|否| UpdateToPendingExec[销售单状态: 待执行]
    
    UpdateToPurchasing --> GeneratePayment[生成押金/销售收款单]
    UpdateToPendingExec --> GeneratePayment
    GeneratePayment --> End([结束])
    
    Error1 --> End
    Error2 --> End
```

---

## 3. 采购单完成流程图

```mermaid
flowchart TD
    Start([开始：采购单流转到已完成]) --> Validate{验证前置条件}
    Validate -->|收货地址不完整| Error1[错误: 必须填写收货地址]
    Validate -->|资产编码为空| Error2[错误: 必须填写资产编码]
    Validate -->|资产编码重复| Error3[错误: 资产编码已存在]
    Validate -->|通过| UpdateStatus[采购单状态: 已完成]
    
    UpdateStatus --> CopyInstance[复制商品实例<br/>订单需求 → 资产规格]
    CopyInstance --> CheckRelation{是否关联销售单?}
    
    CheckRelation -->|是| CreateAssetLocked[创建资产<br/>状态: 锁定]
    CheckRelation -->|否| CreateAssetIdle[创建资产<br/>状态: 闲置]
    
    CreateAssetLocked --> FillAssetLocation[填充资产地址<br/>来自收货地址]
    CreateAssetIdle --> FillAssetLocation
    
    FillAssetLocation --> UpdatePurchaseAssetId[回填资产ID到采购单]
    UpdatePurchaseAssetId --> CheckSalesOrder{关联销售单?}
    
    CheckSalesOrder -->|否| End1([结束])
    CheckSalesOrder -->|是| CreateDemandAssetRelation[创建需求-资产关联]
    
    CreateDemandAssetRelation --> CheckAllDemands{该销售单所有需求<br/>是否都已满足?}
    
    CheckAllDemands -->|否| End2([结束：等待其他采购单])
    CheckAllDemands -->|是| CreateLeasePeriods[创建租期管理数据<br/>租期状态: 待执行]
    CreateLeasePeriods --> UpdateSalesStatus[销售单状态: 待执行]
    UpdateSalesStatus --> SendNotification[发送钉钉通知]
    SendNotification --> End3([结束])
    
    Error1 --> End4([结束])
    Error2 --> End4
    Error3 --> End4
```

---

## 4. 订单执行流程图

```mermaid
flowchart TD
    Start([开始：执行订单]) --> ValidateStatus{销售单状态}
    ValidateStatus -->|不是待执行| Error1[错误: 状态必须是待执行]
    ValidateStatus -->|待执行| CheckPayment{押金/销售款<br/>是否已支付?}
    
    CheckPayment -->|否| Error2[错误: 必须先支付]
    CheckPayment -->|是| CheckAssets{所有需求<br/>是否已分配资产?}
    
    CheckAssets -->|否| Error3[错误: 商品需求未全部分配]
    CheckAssets -->|是| GetBusinessType{业务类型?}
    
    GetBusinessType -->|销售| SalesFlow[销售业务流程]
    GetBusinessType -->|租赁/以租代售| RentalFlow[租赁业务流程]
    
    %% 销售流程
    SalesFlow --> UpdateSalesStatus1[销售单状态: 已完成]
    UpdateSalesStatus1 --> QueryAddress1[查询销售单收货地址]
    QueryAddress1 --> UpdateAssetsSold[批量更新资产]
    UpdateAssetsSold --> SetAssetLocation1[资产地址 = 收货地址]
    SetAssetLocation1 --> SetAssetStatusSold[资产状态: 售出]
    SetAssetStatusSold --> End1([结束])
    
    %% 租赁流程
    RentalFlow --> UpdateSalesStatus2[销售单状态: 执行中]
    UpdateSalesStatus2 --> QueryAddress2[查询销售单收货地址]
    QueryAddress2 --> UpdateLeaseStatus[租期状态: 执行中]
    UpdateLeaseStatus --> CalculateRent[计算实际月租金]
    
    CalculateRent --> GetUpgradePrice[查询增配总价]
    GetUpgradePrice --> ApplyFormula[应用公式:<br/>实际月租金 = <br/>月租金 - 增配 - 资源费<br/>× 预估收租天数 / 实际使用天数]
    ApplyFormula --> GeneratePayments[生成分期租金收款单]
    
    GeneratePayments --> LoopPeriods[按租期月数循环]
    LoopPeriods --> CalcPeriodDate[计算期间日期<br/>按自然月分期]
    CalcPeriodDate --> CalcPeriodAmount[计算期间金额<br/>按实际天数比例]
    CalcPeriodAmount --> CreatePayment[创建租金收款单<br/>状态: 待支付]
    CreatePayment --> MorePeriods{还有期数?}
    
    MorePeriods -->|是| LoopPeriods
    MorePeriods -->|否| UpdateAssetsRented[批量更新资产]
    
    UpdateAssetsRented --> SetAssetLocation2[资产地址 = 收货地址]
    SetAssetLocation2 --> SetAssetStatusRented[资产状态: 在租]
    SetAssetStatusRented --> End2([结束])
    
    Error1 --> End3([结束])
    Error2 --> End3
    Error3 --> End3
```

---

## 5. 状态机图

### 5.1 销售单状态流转

```mermaid
stateDiagram-v2
    [*] --> 待分配: 创建销售单
    
    待分配 --> 采购中: 分配商品（有采购单）
    待分配 --> 待执行: 分配商品（全部资产）
    待分配 --> 已取消: 中止订单
    
    采购中 --> 待执行: 采购全部完成
    采购中 --> 已取消: 中止订单
    
    待执行 --> 执行中: 执行订单（租赁/以租代售）
    待执行 --> 已完成: 执行订单（销售）
    待执行 --> 已取消: 中止订单
    
    执行中 --> 已完成: 租期到期
    执行中 --> 已取消: 全部退租/中止订单
    
    已完成 --> [*]
    已取消 --> [*]
```

### 5.2 采购单状态流转

```mermaid
stateDiagram-v2
    [*] --> 待下单: 销售单创建采购单
    [*] --> 已下单: 手动创建采购单
    
    待下单 --> 已下单: 下单
    已下单 --> 已完成: 完成采购
    
    已完成 --> [*]
    
    [*] --> 待下单: 只能顺序流转<br/>不能跳过状态
```

### 5.3 资产状态流转

```mermaid
stateDiagram-v2
    [*] --> 闲置: 采购入库/退租
    
    闲置 --> 锁定: 分配给销售单
    锁定 --> 在租: 执行订单（租赁）
    锁定 --> 售出: 执行订单（销售）
    锁定 --> 闲置: 销售单中止
    
    在租 --> 闲置: 退租
    
    闲置 --> 维修: 维修
    维修 --> 闲置: 维修完成
    
    闲置 --> 报废: 报废
    售出 --> [*]
    报废 --> [*]
```

### 5.4 租期状态流转

```mermaid
stateDiagram-v2
    [*] --> 待执行: 创建租期
    
    待执行 --> 执行中: 执行订单
    待执行 --> 已取消: 销售单中止
    
    执行中 --> 已完成: 租期到期
    执行中 --> 已取消: 退租/中止
    
    已完成 --> [*]
    已取消 --> [*]
```

### 5.5 收款单状态流转

```mermaid
stateDiagram-v2
    [*] --> 待支付: 生成收款单
    
    待支付 --> 已收款: 收款
    待支付 --> 已逾期: 超过预计日期<br/>定时任务自动检查
    
    已逾期 --> 已收款: 收款
    
    已收款 --> [*]
```

---

## 6. 退租和中止流程图

### 6.1 退租流程

```mermaid
flowchart TD
    Start([开始：退租资产]) --> ValidateStatus{销售单状态}
    ValidateStatus -->|不是执行中| Error1[错误: 只有执行中<br/>才能退租]
    ValidateStatus -->|执行中| CheckReturned{资产是否<br/>已退租?}
    
    CheckReturned -->|是| Error2[错误: 资产已退租]
    CheckReturned -->|否| MarkReturned[标记资产退租<br/>记录退租时间和人]
    
    MarkReturned --> DeleteFuturePayments[删除未来租金单<br/>PeriodStartDate > 当前]
    DeleteFuturePayments --> UpdateAssetStatus[资产状态: 闲置]
    UpdateAssetStatus --> CheckRemaining{销售单是否<br/>还有未退租资产?}
    
    CheckRemaining -->|是| End1([结束])
    CheckRemaining -->|否| AutoCancel[自动触发中止销售单流程]
    AutoCancel --> End2([结束])
    
    Error1 --> End3([结束])
    Error2 --> End3
```

### 6.2 中止销售单流程

```mermaid
flowchart TD
    Start([开始：中止销售单]) --> ValidateStatus{销售单状态}
    ValidateStatus -->|待分配| Error1[错误: 待分配不能中止]
    ValidateStatus -->|已完成| Error2[错误: 已完成不能中止]
    ValidateStatus -->|已取消| Error3[错误: 已经是已取消状态]
    ValidateStatus -->|其他状态| UpdateStatus[销售单状态: 已取消]
    
    UpdateStatus --> QueryPurchases[查询关联的采购单]
    QueryPurchases --> LoopPurchases{遍历采购单}
    
    LoopPurchases --> CheckPurchaseComplete{采购单<br/>是否已完成?}
    CheckPurchaseComplete -->|是| SkipPurchase[跳过：已完成不处理]
    CheckPurchaseComplete -->|否| CheckPrePurchase{是否<br/>预采购单?}
    
    CheckPrePurchase -->|是| RemoveRelation[移除关联关系]
    RemoveRelation --> ClearAddress[置空采购单地址]
    ClearAddress --> SendNotify1[发送取消匹配通知]
    SendNotify1 --> NextPurchase
    
    CheckPrePurchase -->|否| CheckSource{采购单来源?}
    CheckSource -->|销售单创建| DeletePurchase[删除采购单<br/>删除商品实例]
    DeletePurchase --> NextPurchase{还有采购单?}
    CheckSource -->|手动创建| SkipPurchase
    
    SkipPurchase --> NextPurchase
    NextPurchase -->|是| LoopPurchases
    NextPurchase -->|否| QueryAssets[查询未退租资产]
    
    QueryAssets --> RestoreAssets[恢复资产状态: 闲置]
    RestoreAssets --> DeleteFutureRent[删除未来租金单<br/>PeriodStartDate > 当前<br/>状态 = 待支付/已逾期]
    DeleteFutureRent --> UpdateLease[租期状态: 已取消]
    UpdateLease --> End4([结束])
    
    Error1 --> End5([结束])
    Error2 --> End5
    Error3 --> End5
```

---

## 7. 快照机制流程图

```mermaid
flowchart TD
    Start([创建/编辑销售单/采购单]) --> NeedSnapshot{需要地址<br/>或客户快照?}
    
    NeedSnapshot -->|否| NoSnapshot[直接使用引用]
    NeedSnapshot -->|是| CheckExisting{已有快照?}
    
    CheckExisting -->|否| CreateNew[创建新快照]
    CreateNew --> CopyData[复制数据内容]
    CopyData --> SetFlags[IsSnapshot = true<br/>CreateBy = null]
    SetFlags --> UseSnapshot[使用快照ID]
    
    CheckExisting -->|是| UpdateExisting[更新现有快照内容]
    UpdateExisting --> UseSnapshot
    
    UseSnapshot --> UpdateLastUsed[更新原始记录<br/>LastUsedTime]
    UpdateLastUsed --> End([结束])
    
    NoSnapshot --> End
    
    SetFlags -.->|快照特征| SnapshotNote[快照特征：<br/>1. IsSnapshot = true<br/>2. CreateBy = null<br/>3. 不出现在用户列表<br/>4. 只属于订单]
    SnapshotNote -.-> End
```

---

## 8. 租金计算流程图

```mermaid
flowchart TD
    Start([开始：计算租金]) --> GetParams[获取参数<br/>租期月数、赠送天数<br/>月租金、资源费]
    
    GetParams --> GetUpgradePrice[查询增配价格<br/>从ProductTemplateAttributeValue]
    GetUpgradePrice --> CalcRentDays[预估收租天数 =<br/>租期月数 ÷ 12 × 365]
    CalcRentDays --> CalcActualDays[实际使用天数 =<br/>预估收租天数 + 赠送天数]
    
    CalcActualDays --> AdjustPrice[调整后单价 =<br/>月租金 - 增配总价 - 资源费]
    AdjustPrice --> CalcActualPrice[实际月租金 =<br/>调整后单价 × 预估收租天数 ÷ 实际使用天数]
    CalcActualPrice --> RoundPrice[四舍五入保留2位小数]
    
    RoundPrice --> LoopPeriods[按租期月数生成收款单]
    LoopPeriods --> CalcPeriodDates[计算期间日期<br/>按自然月分期]
    
    CalcPeriodDates --> CheckFirstPeriod{是否第一期?}
    CheckFirstPeriod -->|是| FirstPeriodLogic[开始日期 = 起租日期<br/>结束日期 = ClcEndDate]
    CheckFirstPeriod -->|否| CheckLastPeriod{是否最后一期?}
    
    CheckLastPeriod -->|是| LastPeriodLogic[开始日期 = 上期结束+1天<br/>结束日期 = 起租日期+租期月数-1天]
    CheckLastPeriod -->|否| MiddlePeriodLogic[开始日期 = 上期结束+1天<br/>结束日期 = 该月最后一天]
    
    FirstPeriodLogic --> CalcAmount
    LastPeriodLogic --> CalcAmount
    MiddlePeriodLogic --> CalcAmount[计算期间金额]
    
    CalcAmount --> LoopMonths[遍历期间内每个月]
    LoopMonths --> CalcMonthDays[本月实际使用天数]
    CalcMonthDays --> CalcMonthRent[本月租金 =<br/>实际月租金 × 使用天数 ÷ 该月天数]
    CalcMonthRent --> SumRent[累加到期间总租金]
    SumRent --> MoreMonths{还有月份?}
    
    MoreMonths -->|是| LoopMonths
    MoreMonths -->|否| RoundPeriod[四舍五入<br/>最小0.01]
    RoundPeriod --> CreatePayment[创建收款单]
    CreatePayment --> MorePeriods{还有期数?}
    
    MorePeriods -->|是| LoopPeriods
    MorePeriods -->|否| End([结束])
    
    FirstPeriodLogic -.->|ClcEndDate规则| ClcEndDateNote[ClcEndDate规则：<br/>如果距离当月末<5天<br/>则顺延到下月末]
    ClcEndDateNote -.-> CalcAmount
```

---

## 9. 编号生成流程图

### 9.1 销售单编号生成

```mermaid
flowchart TD
    Start([开始：生成销售单编号]) --> Lock[获取互斥锁]
    Lock --> GetBusinessType[获取业务类型]
    GetBusinessType --> MapType{映射业务类型}
    
    MapType -->|租赁| TypeZL[ZL]
    MapType -->|以租代售| TypeYZDS[YZDS]
    MapType -->|销售| TypeXS[XS]
    
    TypeZL --> GetUserIdentifier
    TypeYZDS --> GetUserIdentifier
    TypeXS --> GetUserIdentifier[查询用户钉钉工号]
    
    GetUserIdentifier --> HasJobNumber{有工号?}
    HasJobNumber -->|是| UseJobNumber[使用工号]
    HasJobNumber -->|否| UseUserId[使用用户ID]
    
    UseJobNumber --> BuildPrefix
    UseUserId --> BuildPrefix[构建前缀<br/>TR-类型-工号/ID-日期-]
    
    BuildPrefix --> QueryLatest[查询当天最大流水号]
    QueryLatest --> ParseSequence[解析流水号<br/>默认从1开始]
    ParseSequence --> IncrementSeq[流水号+1]
    
    IncrementSeq --> CheckLimit{流水号>99?}
    CheckLimit -->|是| Error[错误: 当天已达上限]
    CheckLimit -->|否| FormatCode[格式化编号<br/>流水号补零2位]
    
    FormatCode --> ReleaseLock[释放互斥锁]
    ReleaseLock --> End([结束])
    Error --> End
    
    BuildPrefix -.->|示例| CodeExample1[示例编号：<br/>TR-ZL-123456-20250126-01<br/>TR-YZDS-1001-20250126-01]
    CodeExample1 -.-> QueryLatest
```

### 9.2 采购单编号生成

```mermaid
flowchart TD
    Start([开始：生成采购单编号]) --> Lock[获取互斥锁]
    Lock --> GetDate[获取当前日期]
    GetDate --> BuildPrefix[构建前缀<br/>PO + yyyyMMdd]
    
    BuildPrefix --> QueryLatest[查询当天最大流水号<br/>包含已删除]
    QueryLatest --> ParseSequence[解析流水号<br/>默认从1开始]
    ParseSequence --> IncrementSeq[流水号+1]
    
    IncrementSeq --> CheckLimit{流水号>9999?}
    CheckLimit -->|是| Error[错误: 当天已达上限]
    CheckLimit -->|否| FormatCode[格式化编号<br/>流水号补零4位]
    
    FormatCode --> ReleaseLock[释放互斥锁]
    ReleaseLock --> End([结束])
    Error --> End
    
    BuildPrefix -.->|示例| CodeExample2[示例编号：<br/>PO202501190001<br/>PO202501190002]
    CodeExample2 -.-> QueryLatest
```

---

## 10. 定时任务流程图

### 10.1 收款单逾期检查

```mermaid
flowchart TD
    Start([定时任务启动]) --> QueryPending[查询待支付收款单<br/>ExpectedPaymentDate < 当前]
    QueryPending --> HasRecords{有记录?}
    
    HasRecords -->|否| End1([结束])
    HasRecords -->|是| LoopRecords[遍历收款单]
    
    LoopRecords --> UpdateStatus[收款状态: 已逾期]
    UpdateStatus --> SendNotification[发送逾期通知]
    SendNotification --> MoreRecords{还有记录?}
    
    MoreRecords -->|是| LoopRecords
    MoreRecords -->|否| End2([结束])
```

### 10.2 租期到期提醒

```mermaid
flowchart TD
    Start([定时任务启动]) --> CalcReminderDate[计算提醒日期<br/>当前 + N天]
    CalcReminderDate --> QueryLease[查询执行中租期<br/>LeaseEndDate = 提醒日期]
    QueryLease --> HasRecords{有记录?}
    
    HasRecords -->|否| End1([结束])
    HasRecords -->|是| LoopRecords[遍历租期]
    
    LoopRecords --> QuerySalesOrder[查询销售单信息]
    QuerySalesOrder --> SendNotification[发送到期提醒通知]
    SendNotification --> MoreRecords{还有记录?}
    
    MoreRecords -->|是| LoopRecords
    MoreRecords -->|否| End2([结束])
```

### 10.3 租期到期处理

```mermaid
flowchart TD
    Start([定时任务启动]) --> QueryExpired[查询已到期租期<br/>LeaseEndDate < 当前<br/>状态 = 执行中]
    QueryExpired --> HasRecords{有记录?}
    
    HasRecords -->|否| End1([结束])
    HasRecords -->|是| LoopRecords[遍历租期]
    
    LoopRecords --> UpdateLeaseStatus[租期状态: 已完成]
    UpdateLeaseStatus --> CheckOtherLease{该销售单<br/>是否还有<br/>执行中租期?}
    
    CheckOtherLease -->|是| NextRecord
    CheckOtherLease -->|否| UpdateSalesStatus[销售单状态: 已完成]
    UpdateSalesStatus --> NextRecord{还有记录?}
    
    NextRecord -->|是| LoopRecords
    NextRecord -->|否| End2([结束])
```

---

## 附录：Mermaid 图表说明

### 流程图符号说明

- `([圆角矩形])`: 开始/结束节点
- `[矩形]`: 处理步骤
- `{菱形}`: 判断节点
- `-->`: 流程箭头
- `-->|文字|`: 带条件的流程箭头

### 状态机符号说明

- `[*]`: 初始/结束状态
- `状态名`: 具体状态
- `-->`: 状态转换
- `note`: 注释说明

### 查看建议

1. 使用支持 Mermaid 的 Markdown 编辑器查看（如 VS Code + Mermaid 插件）
2. 在 GitHub/GitLab 上查看（原生支持 Mermaid）
3. 使用 Typora 等 Markdown 编辑器查看
4. 在线工具：https://mermaid.live/

---

**文档版本**: 1.0  
**最后更新**: 2025-01-26  
**维护人**: 开发团队

