# 采销库存系统 - 数据字典

## 目录

- [1. 核心业务实体](#1-核心业务实体)
- [2. 关联关系表](#2-关联关系表)
- [3. 日志记录表](#3-日志记录表)
- [4. 枚举类型定义](#4-枚举类型定义)
- [5. 数据约束说明](#5-数据约束说明)

---

## 1. 核心业务实体

### 1.1 销售单 (sales_order)

**表说明**：记录客户的购买或租赁订单信息

| 字段名 | 类型 | 必填 | 说明 | 示例 |
|-------|------|-----|------|------|
| sales_order_id | bigint | 是 | 销售单ID（雪花ID，主键） | 1234567890123456 |
| sales_order_code | varchar(50) | 是 | 销售单编号（唯一索引） | TR-ZL-123456-20250126-01 |
| sales_status | int | 是 | 销售单状态（0-5） | 0=待分配, 1=采购中, 2=待执行, 3=执行中, 4=已完成, 5=已取消 |
| business_type | int | 是 | 业务类型（1-3） | 1=租赁, 2=以租代售, 3=销售 |
| customer_id | bigint | 是 | 客户ID（外键，指向快照） | 9876543210987654 |
| delivery_address_id | bigint | 是 | 收货地址ID（外键，指向快照） | 1111222233334444 |
| total_deposit | decimal(18,2) | 否 | 总押金（租赁/以租代售必填） | 10000.00 |
| dept_id | bigint | 否 | 部门ID（外键） | 100 |
| remark | text | 否 | 备注 | 客户要求提前交货 |
| is_deleted | bit | 是 | 是否删除（逻辑删除） | 0=未删除, 1=已删除 |
| create_by | varchar(64) | 否 | 创建人 | admin |
| create_time | datetime | 是 | 创建时间 | 2025-01-26 10:00:00 |
| update_by | varchar(64) | 否 | 更新人 | admin |
| update_time | datetime | 否 | 更新时间 | 2025-01-26 15:30:00 |

**索引**：
- PRIMARY KEY: `sales_order_id`
- UNIQUE KEY: `sales_order_code`
- INDEX: `customer_id`, `sales_status`, `create_time`

**外键关系**：
- `customer_id` → `customer.customer_id`（客户快照）
- `delivery_address_id` → `delivery_address.delivery_address_id`（地址快照）
- `dept_id` → `sys_dept.dept_id`（部门）

---

### 1.2 商品需求 (sales_order_product_demand)

**表说明**：记录销售单中每个商品的需求明细

| 字段名 | 类型 | 必填 | 说明 | 示例 |
|-------|------|-----|------|------|
| demand_id | bigint | 是 | 需求ID（主键） | 1234567890123456 |
| sales_order_id | bigint | 是 | 销售单ID（外键） | 9876543210987654 |
| sales_order_code | varchar(50) | 是 | 销售单编号（冗余字段） | TR-ZL-123456-20250126-01 |
| product_instance_id | bigint | 是 | 商品实例ID（外键） | 5555666677778888 |
| required_quantity | int | 是 | 需求数量 | 5 |
| unit_price | decimal(18,2) | 是 | 单价（月租金或售价） | 3000.00 |
| commission_price | decimal(18,2) | 否 | 资源费（租赁业务） | 100.00 |
| rental_period | int | 否 | 租期月数（租赁业务） | 12 |
| remark | text | 否 | 备注 | 需要配置高性能版本 |

**索引**：
- PRIMARY KEY: `demand_id`
- INDEX: `sales_order_id`, `product_instance_id`

**外键关系**：
- `sales_order_id` → `sales_order.sales_order_id`
- `product_instance_id` → `product_instance.product_instance_id`

---

### 1.3 采购单 (purchase_order)

**表说明**：记录向供应商采购设备的信息

| 字段名 | 类型 | 必填 | 说明 | 示例 |
|-------|------|-----|------|------|
| purchase_order_id | bigint | 是 | 采购单ID（主键） | 1234567890123456 |
| purchase_order_code | varchar(50) | 是 | 采购单编号（唯一索引） | PO202501190001 |
| purchase_status | int | 是 | 采购状态（0-2） | 0=待下单, 1=已下单, 2=已完成 |
| purchase_source | int | 是 | 采购来源（0-1） | 0=手动创建, 1=销售单创建 |
| is_pre_purchase | bit | 是 | 是否预采购单 | 0=否, 1=是 |
| product_instance_id | bigint | 是 | 商品实例ID（外键） | 5555666677778888 |
| asset_code | varchar(100) | 否 | 资产编码（完成时必填） | AS-2025-0001 |
| asset_id | bigint | 否 | 资产ID（完成后回填） | 9999888877776666 |
| delivery_address_id | bigint | 否 | 收货地址ID（外键） | 1111222233334444 |
| remark | text | 否 | 备注 | 需要额外配件 |
| is_deleted | bit | 是 | 是否删除 | 0=未删除, 1=已删除 |
| create_by | varchar(64) | 否 | 创建人 | admin |
| create_time | datetime | 是 | 创建时间 | 2025-01-19 10:00:00 |
| update_by | varchar(64) | 否 | 更新人 | admin |
| update_time | datetime | 否 | 更新时间 | 2025-01-19 15:30:00 |

**索引**：
- PRIMARY KEY: `purchase_order_id`
- UNIQUE KEY: `purchase_order_code`
- INDEX: `purchase_status`, `asset_code`, `create_time`

**外键关系**：
- `product_instance_id` → `product_instance.product_instance_id`
- `asset_id` → `asset.asset_id`
- `delivery_address_id` → `delivery_address.delivery_address_id`

**业务约束**：
- `is_pre_purchase = 1` 时，`delivery_address_id` 必须为 NULL
- `purchase_source = 1` 时，`is_pre_purchase` 必须为 0
- `purchase_status = 2` 时，`asset_code` 和 `asset_id` 不能为 NULL

---

### 1.4 资产 (asset)

**表说明**：记录公司库存设备的详细信息

| 字段名 | 类型 | 必填 | 说明 | 示例 |
|-------|------|-----|------|------|
| asset_id | bigint | 是 | 资产ID（主键） | 1234567890123456 |
| asset_code | varchar(100) | 是 | 资产编码（唯一索引） | AS-2025-0001 |
| asset_status | int | 是 | 资产状态（0-5） | 0=闲置, 1=在租, 2=锁定, 3=维修, 4=售出, 5=报废 |
| asset_source | int | 是 | 资产来源（0-1） | 0=采购入库, 1=手动创建 |
| product_instance_id | bigint | 是 | 商品实例ID（外键） | 5555666677778888 |
| province_code | varchar(20) | 否 | 省份代码 | 110000 |
| province_name | varchar(50) | 否 | 省份名称 | 北京市 |
| city_code | varchar(20) | 否 | 城市代码 | 110100 |
| city_name | varchar(50) | 否 | 城市名称 | 北京市 |
| location_detail | varchar(500) | 否 | 详细地址 | 朝阳区建国路88号 |
| responsible_user_id | bigint | 否 | 责任人ID（外键） | 1001 |
| remark | text | 否 | 备注 | 设备状态良好 |
| is_deleted | bit | 是 | 是否删除 | 0=未删除, 1=已删除 |
| create_by | varchar(64) | 否 | 创建人 | admin |
| create_time | datetime | 是 | 创建时间 | 2025-01-19 16:00:00 |
| update_by | varchar(64) | 否 | 更新人 | admin |
| update_time | datetime | 否 | 更新时间 | 2025-01-20 10:00:00 |

**索引**：
- PRIMARY KEY: `asset_id`
- UNIQUE KEY: `asset_code`
- INDEX: `asset_status`, `product_instance_id`, `responsible_user_id`

**外键关系**：
- `product_instance_id` → `product_instance.product_instance_id`
- `responsible_user_id` → `sys_user.user_id`

---

### 1.5 租期管理 (lease_period)

**表说明**：记录租赁业务的租期信息

| 字段名 | 类型 | 必填 | 说明 | 示例 |
|-------|------|-----|------|------|
| lease_period_id | bigint | 是 | 租期ID（主键） | 1234567890123456 |
| relation_id | bigint | 是 | 关联记录ID（外键） | 9876543210987654 |
| sales_order_id | bigint | 是 | 销售单ID（外键） | 5555666677778888 |
| sales_order_code | varchar(50) | 是 | 销售单编号 | TR-ZL-123456-20250126-01 |
| demand_id | bigint | 是 | 需求ID（外键） | 1111222233334444 |
| asset_id | bigint | 是 | 资产ID（外键） | 9999888877776666 |
| lease_start_date | datetime | 是 | 起租日期 | 2025-02-01 00:00:00 |
| lease_end_date | datetime | 是 | 结束日期 | 2026-01-31 23:59:59 |
| bonus_days | int | 是 | 赠送天数 | 30 |
| is_bonus_at_start | bit | 是 | 赠送天数是否前置 | 0=后置, 1=前置 |
| lease_status | int | 是 | 租期状态（0-3） | 0=待执行, 1=执行中, 2=已完成, 3=已取消 |
| create_by | varchar(64) | 否 | 创建人 | admin |
| create_time | datetime | 是 | 创建时间 | 2025-01-26 16:00:00 |
| update_by | varchar(64) | 否 | 更新人 | admin |
| update_time | datetime | 否 | 更新时间 | 2025-02-01 09:00:00 |

**索引**：
- PRIMARY KEY: `lease_period_id`
- INDEX: `relation_id`, `sales_order_id`, `asset_id`, `lease_end_date`, `lease_status`

**外键关系**：
- `relation_id` → `product_demand_asset_relation.relation_id`
- `sales_order_id` → `sales_order.sales_order_id`
- `demand_id` → `sales_order_product_demand.demand_id`
- `asset_id` → `asset.asset_id`

---

### 1.6 收款单 (payment_record)

**表说明**：记录所有收款信息（押金、销售款、租金）

| 字段名 | 类型 | 必填 | 说明 | 示例 |
|-------|------|-----|------|------|
| payment_record_id | bigint | 是 | 收款单ID（主键） | 1234567890123456 |
| payment_type | int | 是 | 收款类型（0-2） | 0=押金, 1=销售, 2=租金 |
| payment_status | int | 是 | 收款状态（0-2） | 0=待支付, 1=已收款, 2=已逾期 |
| sales_order_id | bigint | 是 | 销售单ID（外键） | 9876543210987654 |
| sales_order_code | varchar(50) | 是 | 销售单编号 | TR-ZL-123456-20250126-01 |
| relation_id | bigint | 否 | 关联记录ID（租金单） | 5555666677778888 |
| demand_id | bigint | 否 | 需求ID（租金单） | 1111222233334444 |
| asset_id | bigint | 否 | 资产ID（租金单） | 9999888877776666 |
| expected_amount | decimal(18,2) | 否 | 应收金额 | 10000.00 |
| actual_price | decimal(18,2) | 否 | 实际月租金（租金单） | 2494.94 |
| expected_payment_date | datetime | 否 | 预计收款日期 | 2025-02-06 00:00:00 |
| actual_payment_date | datetime | 否 | 实际收款日期 | 2025-02-05 14:30:00 |
| rental_period | int | 否 | 租期月数（租金单） | 12 |
| period_number | int | 否 | 期数（租金单） | 1 |
| period_start_date | datetime | 否 | 期间开始日期（租金单） | 2025-02-01 00:00:00 |
| period_end_date | datetime | 否 | 期间结束日期（租金单） | 2025-02-28 23:59:59 |
| create_by | varchar(64) | 否 | 创建人 | admin |
| create_time | datetime | 是 | 创建时间 | 2025-01-26 16:30:00 |
| update_by | varchar(64) | 否 | 更新人 | admin |
| update_time | datetime | 否 | 更新时间 | 2025-02-05 14:30:00 |

**索引**：
- PRIMARY KEY: `payment_record_id`
- INDEX: `sales_order_id`, `payment_type`, `payment_status`, `expected_payment_date`, `asset_id`

**外键关系**：
- `sales_order_id` → `sales_order.sales_order_id`
- `relation_id` → `product_demand_asset_relation.relation_id`
- `demand_id` → `sales_order_product_demand.demand_id`
- `asset_id` → `asset.asset_id`

**字段约束**：
- `payment_type = 2` 时，`relation_id`、`demand_id`、`asset_id`、`actual_price`、`period_number`、`period_start_date`、`period_end_date` 不能为 NULL
- `payment_type = 0 或 1` 时，上述字段应为 NULL

---

### 1.7 客户 (customer)

**表说明**：记录客户信息（包括快照数据）

| 字段名 | 类型 | 必填 | 说明 | 示例 |
|-------|------|-----|------|------|
| customer_id | bigint | 是 | 客户ID（主键） | 1234567890123456 |
| company_name | varchar(200) | 否 | 公司名称 | XX科技有限公司 |
| customer_name | varchar(100) | 是 | 客户姓名 | 张三 |
| contact_phone | varchar(20) | 是 | 联系电话 | 13800138000 |
| address | varchar(500) | 否 | 地址 | 北京市朝阳区 |
| is_snapshot | bit | 是 | 是否快照 | 0=非快照, 1=快照 |
| last_used_time | datetime | 否 | 最后使用时间 | 2025-01-26 10:00:00 |
| is_deleted | bit | 是 | 是否删除 | 0=未删除, 1=已删除 |
| create_by | varchar(64) | 否 | 创建人（快照为NULL） | admin |
| create_time | datetime | 是 | 创建时间 | 2025-01-20 10:00:00 |
| update_by | varchar(64) | 否 | 更新人 | admin |
| update_time | datetime | 否 | 更新时间 | 2025-01-26 10:00:00 |

**索引**：
- PRIMARY KEY: `customer_id`
- INDEX: `contact_phone`, `is_snapshot`, `create_by`, `last_used_time`

**说明**：
- `is_snapshot = 1` 的记录是销售单的客户快照
- `create_by = NULL` 标识快照数据
- 快照数据不出现在用户的客户列表中

---

### 1.8 收货地址 (delivery_address)

**表说明**：记录收货地址信息（包括快照数据）

| 字段名 | 类型 | 必填 | 说明 | 示例 |
|-------|------|-----|------|------|
| delivery_address_id | bigint | 是 | 地址ID（主键） | 1234567890123456 |
| receiver_name | varchar(100) | 是 | 收货人姓名 | 李四 |
| receiver_phone | varchar(20) | 是 | 收货人电话 | 13900139000 |
| province_code | varchar(20) | 是 | 省份代码 | 110000 |
| province_name | varchar(50) | 是 | 省份名称 | 北京市 |
| city_code | varchar(20) | 是 | 城市代码 | 110100 |
| city_name | varchar(50) | 是 | 城市名称 | 北京市 |
| address_detail | varchar(500) | 是 | 详细地址 | 朝阳区建国路88号 |
| is_snapshot | bit | 是 | 是否快照 | 0=非快照, 1=快照 |
| last_used_time | datetime | 否 | 最后使用时间 | 2025-01-26 10:00:00 |
| is_deleted | bit | 是 | 是否删除 | 0=未删除, 1=已删除 |
| create_by | varchar(64) | 否 | 创建人（快照为NULL） | admin |
| create_time | datetime | 是 | 创建时间 | 2025-01-20 10:00:00 |
| update_by | varchar(64) | 否 | 更新人 | admin |
| update_time | datetime | 否 | 更新时间 | 2025-01-26 10:00:00 |

**索引**：
- PRIMARY KEY: `delivery_address_id`
- INDEX: `is_snapshot`, `create_by`, `last_used_time`

**说明**：
- `is_snapshot = 1` 的记录是订单的地址快照
- `create_by = NULL` 标识快照数据

---

### 1.9 商品实例 (product_instance)

**表说明**：记录商品的具体配置信息

| 字段名 | 类型 | 必填 | 说明 | 示例 |
|-------|------|-----|------|------|
| product_instance_id | bigint | 是 | 商品实例ID（主键） | 1234567890123456 |
| entity_type | int | 是 | 实体类型（1-2） | 1=订单需求, 2=资产规格 |
| product_template_id | bigint | 是 | 商品模板ID（外键） | 9876543210987654 |
| product_name | varchar(200) | 是 | 商品名称 | 高性能服务器 |
| business_type | int | 是 | 业务类型（1-3） | 1=租赁, 2=以租代售, 3=销售 |
| search_content | text | 否 | 搜索内容（属性拼接） | CPU:Intel i9,内存:32GB,硬盘:1TB SSD |
| attribute_hash | varchar(64) | 否 | 属性哈希（用于匹配） | abc123def456... |

**索引**：
- PRIMARY KEY: `product_instance_id`
- INDEX: `product_template_id`, `attribute_hash`

**外键关系**：
- `product_template_id` → `product_template.product_template_id`

---

### 1.10 商品实例属性值 (product_instance_attribute_value)

**表说明**：记录商品实例的属性值

| 字段名 | 类型 | 必填 | 说明 | 示例 |
|-------|------|-----|------|------|
| instance_attr_value_id | bigint | 是 | 属性值ID（主键） | 1234567890123456 |
| product_instance_id | bigint | 是 | 商品实例ID（外键） | 9876543210987654 |
| template_attribute_id | bigint | 是 | 模板属性ID（外键） | 5555666677778888 |
| attribute_name | varchar(100) | 是 | 属性名称 | CPU |
| template_attribute_value_id | bigint | 否 | 模板属性值ID（下拉框） | 1111222233334444 |
| attribute_value_name | varchar(200) | 是 | 属性值名称 | Intel i9-13900K |

**索引**：
- PRIMARY KEY: `instance_attr_value_id`
- INDEX: `product_instance_id`, `template_attribute_id`

**外键关系**：
- `product_instance_id` → `product_instance.product_instance_id`
- `template_attribute_id` → `product_template_attribute.template_attribute_id`
- `template_attribute_value_id` → `product_template_attribute_value.template_attribute_value_id`

**说明**：
- 下拉框类型属性：`template_attribute_value_id` 有值
- 输入框类型属性：`template_attribute_value_id` 为 NULL

---

## 2. 关联关系表

### 2.1 商品需求-资产关联 (product_demand_asset_relation)

**表说明**：记录商品需求和资产的分配关系

| 字段名 | 类型 | 必填 | 说明 | 示例 |
|-------|------|-----|------|------|
| relation_id | bigint | 是 | 关联ID（主键） | 1234567890123456 |
| sales_order_id | bigint | 是 | 销售单ID（外键） | 9876543210987654 |
| sales_order_code | varchar(50) | 是 | 销售单编号 | TR-ZL-123456-20250126-01 |
| demand_id | bigint | 是 | 需求ID（外键） | 5555666677778888 |
| asset_id | bigint | 是 | 资产ID（外键） | 1111222233334444 |
| is_returned | bit | 是 | 是否已退租 | 0=未退租, 1=已退租 |
| return_time | datetime | 否 | 退租时间 | 2025-12-01 10:00:00 |
| return_by | varchar(64) | 否 | 退租操作人 | admin |

**索引**：
- PRIMARY KEY: `relation_id`
- INDEX: `sales_order_id`, `demand_id`, `asset_id`, `is_returned`

**外键关系**：
- `sales_order_id` → `sales_order.sales_order_id`
- `demand_id` → `sales_order_product_demand.demand_id`
- `asset_id` → `asset.asset_id`

---

### 2.2 商品需求-采购单关联 (product_demand_purchase_order_relation)

**表说明**：记录商品需求和采购单的关联关系

| 字段名 | 类型 | 必填 | 说明 | 示例 |
|-------|------|-----|------|------|
| relation_id | bigint | 是 | 关联ID（主键） | 1234567890123456 |
| demand_id | bigint | 是 | 需求ID（外键） | 9876543210987654 |
| sales_order_id | bigint | 是 | 销售单ID（外键） | 5555666677778888 |
| sales_order_code | varchar(50) | 是 | 销售单编号 | TR-ZL-123456-20250126-01 |
| purchase_order_id | bigint | 是 | 采购单ID（外键） | 1111222233334444 |
| purchase_order_code | varchar(50) | 是 | 采购单编号 | PO202501190001 |

**索引**：
- PRIMARY KEY: `relation_id`
- INDEX: `demand_id`, `sales_order_id`, `purchase_order_id`

**外键关系**：
- `demand_id` → `sales_order_product_demand.demand_id`
- `sales_order_id` → `sales_order.sales_order_id`
- `purchase_order_id` → `purchase_order.purchase_order_id`

---

## 3. 日志记录表

### 3.1 销售单状态流转日志 (sales_order_status_log)

**表说明**：记录销售单状态的每次变更

| 字段名 | 类型 | 必填 | 说明 | 示例 |
|-------|------|-----|------|------|
| status_log_id | bigint | 是 | 日志ID（主键） | 1234567890123456 |
| sales_order_id | bigint | 是 | 销售单ID（外键） | 9876543210987654 |
| sales_order_code | varchar(50) | 是 | 销售单编号 | TR-ZL-123456-20250126-01 |
| previous_status | int | 否 | 前一个状态 | 0=待分配（NULL表示初始状态） |
| current_status | int | 是 | 当前状态 | 1=采购中 |
| change_reason | varchar(500) | 是 | 流转原因 | 关联采购单，进入采购中 |
| create_by | varchar(64) | 否 | 操作人 | admin |
| create_time | datetime | 是 | 流转时间 | 2025-01-26 16:00:00 |

**索引**：
- PRIMARY KEY: `status_log_id`
- INDEX: `sales_order_id`, `create_time`

**外键关系**：
- `sales_order_id` → `sales_order.sales_order_id`

---

### 3.2 采购单状态流转日志 (purchase_order_status_log)

**表说明**：记录采购单状态的每次变更

| 字段名 | 类型 | 必填 | 说明 | 示例 |
|-------|------|-----|------|------|
| status_log_id | bigint | 是 | 日志ID（主键） | 1234567890123456 |
| purchase_order_id | bigint | 是 | 采购单ID（外键） | 9876543210987654 |
| previous_status | int | 否 | 前一个状态 | 0=待下单（NULL表示初始状态） |
| current_status | int | 是 | 当前状态 | 1=已下单 |
| change_reason | varchar(500) | 是 | 流转原因 | 已向供应商下单 |
| create_by | varchar(64) | 否 | 操作人 | admin |
| create_time | datetime | 是 | 流转时间 | 2025-01-19 14:00:00 |

**索引**：
- PRIMARY KEY: `status_log_id`
- INDEX: `purchase_order_id`, `create_time`

**外键关系**：
- `purchase_order_id` → `purchase_order.purchase_order_id`

---

### 3.3 资产状态流转日志 (asset_status_log)

**表说明**：记录资产状态的每次变更

| 字段名 | 类型 | 必填 | 说明 | 示例 |
|-------|------|-----|------|------|
| status_log_id | bigint | 是 | 日志ID（主键） | 1234567890123456 |
| asset_id | bigint | 是 | 资产ID（外键） | 9876543210987654 |
| asset_code | varchar(100) | 是 | 资产编码 | AS-2025-0001 |
| previous_status | int | 否 | 前一个状态 | 0=闲置（NULL表示初始状态） |
| current_status | int | 是 | 当前状态 | 2=锁定 |
| change_reason | varchar(500) | 是 | 流转原因 | 分配给销售单 TR-ZL-123456-20250126-01 |
| create_by | varchar(64) | 否 | 操作人 | admin |
| create_time | datetime | 是 | 流转时间 | 2025-01-26 16:00:00 |

**索引**：
- PRIMARY KEY: `status_log_id`
- INDEX: `asset_id`, `create_time`

**外键关系**：
- `asset_id` → `asset.asset_id`

---

### 3.4 资产地址变更日志 (asset_location_log)

**表说明**：记录资产地址的每次变更

| 字段名 | 类型 | 必填 | 说明 | 示例 |
|-------|------|-----|------|------|
| location_log_id | bigint | 是 | 日志ID（主键） | 1234567890123456 |
| asset_id | bigint | 是 | 资产ID（外键） | 9876543210987654 |
| asset_code | varchar(100) | 是 | 资产编码 | AS-2025-0001 |
| previous_province_code | varchar(20) | 否 | 前一个省份代码 | 110000 |
| previous_province_name | varchar(50) | 否 | 前一个省份名称 | 北京市 |
| previous_city_code | varchar(20) | 否 | 前一个城市代码 | 110100 |
| previous_city_name | varchar(50) | 否 | 前一个城市名称 | 北京市 |
| previous_location_detail | varchar(500) | 否 | 前一个详细地址 | 朝阳区建国路88号 |
| current_province_code | varchar(20) | 是 | 当前省份代码 | 310000 |
| current_province_name | varchar(50) | 是 | 当前省份名称 | 上海市 |
| current_city_code | varchar(20) | 是 | 当前城市代码 | 310100 |
| current_city_name | varchar(50) | 是 | 当前城市名称 | 上海市 |
| current_location_detail | varchar(500) | 是 | 当前详细地址 | 浦东新区陆家嘴环路1000号 |
| change_reason | varchar(500) | 是 | 变更原因 | 销售单 TR-ZL-123456-20250126-01 开始执行 |
| create_by | varchar(64) | 否 | 操作人 | admin |
| create_time | datetime | 是 | 变更时间 | 2025-02-01 10:00:00 |

**索引**：
- PRIMARY KEY: `location_log_id`
- INDEX: `asset_id`, `create_time`

**外键关系**：
- `asset_id` → `asset.asset_id`

---

## 4. 枚举类型定义

### 4.1 销售单状态 (SalesStatus)

| 枚举值 | 名称 | 说明 |
|-------|------|------|
| 0 | 待分配 | 销售单已创建，等待分配资产或创建采购单 |
| 1 | 采购中 | 关联的采购单正在采购过程中 |
| 2 | 待执行 | 资产已全部准备好，等待执行配送或交付 |
| 3 | 执行中 | 正在执行配送、安装或其他交付流程 |
| 4 | 已完成 | 销售单已完成，所有商品已交付 |
| 5 | 已取消 | 销售单已取消 |

---

### 4.2 采购单状态 (PurchaseStatus)

| 枚举值 | 名称 | 说明 |
|-------|------|------|
| 0 | 待下单 | 销售单创建的采购单默认状态 |
| 1 | 已下单 | 手动创建的采购单默认状态，已向供应商下单 |
| 2 | 已完成 | 采购完成，资产已入库 |

---

### 4.3 资产状态 (AssetStatus)

| 枚举值 | 名称 | 说明 |
|-------|------|------|
| 0 | 闲置 | 资产当前可用且未被分配或租赁 |
| 1 | 在租 | 资产已经出租，对应对外租赁或使用中的状态 |
| 2 | 锁定 | 资产暂时被业务锁定，可能等待审核或即将被调度 |
| 3 | 维修 | 资产正在维修，暂时无法对外提供服务 |
| 4 | 售出 | 资产已经售出，不再属于公司资产库存 |
| 5 | 报废 | 资产已报废无法使用，需要进行资产清理处置 |

---

### 4.4 租期状态 (LeaseStatus)

| 枚举值 | 名称 | 说明 |
|-------|------|------|
| 0 | 待执行 | 租期已创建，等待起租 |
| 1 | 执行中 | 租期正在进行中 |
| 2 | 已完成 | 租期已正常结束 |
| 3 | 已取消 | 租期已取消或提前终止 |

---

### 4.5 收款状态 (PaymentStatus)

| 枚举值 | 名称 | 说明 |
|-------|------|------|
| 0 | 待支付 | 收款单已生成，等待客户支付 |
| 1 | 已收款 | 已完成收款 |
| 2 | 已逾期 | 超过预计收款日期仍未收款 |

---

### 4.6 业务类型 (BusinesType)

| 枚举值 | 名称 | 说明 |
|-------|------|------|
| 1 | 租赁 | 设备租赁业务 |
| 2 | 以租代售 | 租期结束后设备归客户所有 |
| 3 | 销售 | 直接销售设备 |

---

### 4.7 收款类型 (PaymentType)

| 枚举值 | 名称 | 说明 |
|-------|------|------|
| 0 | 押金 | 租赁/以租代售业务的押金 |
| 1 | 销售 | 销售业务的销售款 |
| 2 | 租金 | 租赁/以租代售业务的分期租金 |

---

### 4.8 采购来源 (PurchaseSource)

| 枚举值 | 名称 | 说明 |
|-------|------|------|
| 0 | 手动创建 | 用户手动创建的采购单 |
| 1 | 销售单创建 | 商品分配时自动创建的采购单 |

---

### 4.9 资产来源 (AssetSource)

| 枚举值 | 名称 | 说明 |
|-------|------|------|
| 0 | 采购入库 | 采购单完成后自动创建 |
| 1 | 手动创建 | 用户手动创建资产 |

---

### 4.10 实体类型 (EntityType)

| 枚举值 | 名称 | 说明 |
|-------|------|------|
| 1 | 订单需求 | 商品实例关联到订单需求 |
| 2 | 资产规格 | 商品实例关联到资产 |

---

## 5. 数据约束说明

### 5.1 唯一性约束

| 表名 | 字段 | 约束说明 |
|-----|------|---------|
| sales_order | sales_order_code | 销售单编号全局唯一 |
| purchase_order | purchase_order_code | 采购单编号全局唯一 |
| asset | asset_code | 资产编码全局唯一 |

---

### 5.2 业务逻辑约束

#### 5.2.1 销售单约束

1. **状态流转约束**：
   - 只能按特定路径流转，不能跳跃（详见状态流转图）
   - 已完成和已取消状态不能再流转

2. **业务类型约束**：
   - 租赁/以租代售：`total_deposit` 必须填写
   - 销售：`total_deposit` 可以为空

3. **删除约束**：
   - 只有待分配状态的销售单可以删除
   - 删除会级联删除关联数据

---

#### 5.2.2 采购单约束

1. **状态流转约束**：
   - 只能顺序流转：待下单 → 已下单 → 已完成
   - 不能跳过状态

2. **预采购单约束**：
   - `is_pre_purchase = 1` 时，`delivery_address_id` 必须为 NULL
   - 销售单创建的采购单不能是预采购单

3. **完成约束**：
   - 流转到已完成时，`asset_code` 必须填写
   - 流转到已完成时，`delivery_address_id` 必须填写且地址信息完整

4. **删除约束**：
   - 只能删除手动创建且未完成的采购单
   - 已关联销售单的预采购单不能删除

---

#### 5.2.3 资产约束

1. **编码唯一性**：
   - `asset_code` 全局唯一
   - 创建和修改时都会检查重复

2. **状态流转约束**：
   - 参见资产状态流转图
   - 售出和报废状态不能再流转

3. **删除约束**：
   - 只能删除闲置状态的资产
   - 已关联订单的资产不能删除

---

#### 5.2.4 租期约束

1. **日期约束**：
   - `lease_end_date` = `lease_start_date` + `rental_period` 个月
   - 如果 `is_bonus_at_start = false`：`lease_end_date` += `bonus_days` 天

2. **业务类型约束**：
   - 只有租赁和以租代售业务才有租期
   - 销售业务不创建租期

3. **状态约束**：
   - 租期状态与销售单状态联动
   - 租期到期自动更新状态

---

#### 5.2.5 收款单约束

1. **收款类型约束**：
   - 押金：租赁/以租代售业务，商品分配后生成
   - 销售：销售业务，商品分配后生成
   - 租金：租赁/以租代售业务，订单执行后生成

2. **租金单字段约束**：
   - `payment_type = 2` 时，必须填写：
     - `relation_id`
     - `demand_id`
     - `asset_id`
     - `actual_price`
     - `period_number`
     - `period_start_date`
     - `period_end_date`

3. **修改约束**：
   - 只有待支付或已逾期状态可以修改金额
   - 已收款状态不能修改

---

#### 5.2.6 快照数据约束

1. **标识约束**：
   - `is_snapshot = 1`
   - `create_by = NULL`

2. **查询约束**：
   - 用户列表查询时过滤快照数据
   - 只有通过订单才能访问快照数据

3. **删除约束**：
   - 快照数据只能随订单一起删除
   - 不能单独删除

---

### 5.3 数据完整性约束

#### 5.3.1 外键约束

所有外键字段都必须引用已存在的记录，包括：

- 销售单 → 客户、收货地址、部门
- 商品需求 → 销售单、商品实例
- 采购单 → 商品实例、收货地址、资产
- 资产 → 商品实例、责任人
- 租期 → 销售单、需求、资产、关联记录
- 收款单 → 销售单、需求、资产、关联记录

---

#### 5.3.2 级联操作

**级联删除**：
- 删除销售单 → 删除商品需求、收款单、租期、关联记录、快照数据
- 删除商品实例 → 删除属性值

**不允许级联删除**：
- 删除客户/地址 → 如果有关联的非快照订单，不允许删除
- 删除资产 → 如果有关联订单，不允许删除

---

#### 5.3.3 软删除

系统使用软删除机制（`is_deleted` 字段），以下实体支持软删除：

- 销售单
- 采购单
- 资产
- 客户
- 收货地址

**软删除规则**：
- `is_deleted = 1` 表示已删除
- 查询时默认过滤已删除数据
- 编号生成时包含已删除数据（避免编号冲突）

---

## 附录

### A. 数据库设计原则

1. **雪花ID**：所有主键使用雪花ID（bigint）
2. **软删除**：核心业务表使用软删除机制
3. **审计字段**：包含 `create_by`, `create_time`, `update_by`, `update_time`
4. **冗余字段**：适当冗余提高查询性能（如 `sales_order_code`）
5. **快照机制**：客户和地址使用快照保证历史数据准确性

---

### B. 命名规范

1. **表名**：小写字母，下划线分隔，复数形式（如 `sales_orders`）
2. **字段名**：小写字母，下划线分隔（如 `sales_order_id`）
3. **外键命名**：`表名_id`（如 `customer_id`）
4. **索引命名**：`idx_表名_字段名`（如 `idx_sales_order_status`）
5. **唯一索引命名**：`uk_表名_字段名`（如 `uk_sales_order_code`）

---

### C. 性能优化建议

1. **索引策略**：
   - 所有外键字段建立索引
   - 常用查询条件建立复合索引
   - 状态字段建立索引

2. **分区策略**：
   - 大表按日期分区（如按月或年）
   - 日志表使用分区表提高查询性能

3. **归档策略**：
   - 定期归档历史数据
   - 保留近1-2年的在线数据

---

**文档版本**: 1.0  
**最后更新**: 2025-01-26  
**维护人**: 开发团队

